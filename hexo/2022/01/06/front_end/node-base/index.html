<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Node 知识梳理（一） | iZph-FE</title>
  <meta name="description" content="Node 是一个基于谷歌V8引擎的一个JavaScript运行环境（runtime运行时），是服务端的运行环境。 Node 的特点是事件驱动、非阻塞式 I&#x2F;O（input&#x2F;output）、单线程。触发一次事件，执行回调，是事件驱动的一种体现。  Node的使用场景 I&#x2F;O 密集型场景 提供http接口，组装数据 RPC服务，RPC（Remote Procedure">
<meta property="og:type" content="article">
<meta property="og:title" content="Node 知识梳理（一）">
<meta property="og:url" content="http://example.com/2022/01/06/front_end/node-base/index.html">
<meta property="og:site_name" content="前端点点滴滴">
<meta property="og:description" content="Node 是一个基于谷歌V8引擎的一个JavaScript运行环境（runtime运行时），是服务端的运行环境。 Node 的特点是事件驱动、非阻塞式 I&#x2F;O（input&#x2F;output）、单线程。触发一次事件，执行回调，是事件驱动的一种体现。  Node的使用场景 I&#x2F;O 密集型场景 提供http接口，组装数据 RPC服务，RPC（Remote Procedure">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/front_end/nodejs-runtime001.png">
<meta property="article:published_time" content="2022-01-05T22:15:33.000Z">
<meta property="article:modified_time" content="2022-07-08T14:22:02.526Z">
<meta property="article:author" content="zhongph">
<meta property="article:tag" content="Node">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/front_end/nodejs-runtime001.png">
  <!-- Canonical links -->
  <link rel="canonical" href="http://example.com/2022/01/06/front_end/node-base/index.html">
  
    <link rel="alternate" href="/atom.xml" title="前端点点滴滴" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 6.2.0"></head>


<body class="main-center theme-purple" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/izph" target="_blank">
          <img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">iZph</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">Front End Developer</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> 北京</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">标签</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">项目</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-books">
          <a href="/books">
            
            <i class="icon icon-book-fill"></i>
            
            <span class="menu-title">书单</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">友链</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">关于</span>
          </a>
        </li>
        
      </ul>
      
    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>iZph's Blog：欢迎交流与分享经验哈!</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B7%A5%E7%A8%8B%E5%8C%96/">工程化</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/">计算机基础</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签</h3>
    <div class="widget-body">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Koa/" rel="tag">Koa</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Node/" rel="tag">Node</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/" rel="tag">React</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TypeScript/" rel="tag">TypeScript</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Webpack/" rel="tag">Webpack</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" rel="tag">数据结构与算法</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B5%8F%E8%A7%88%E5%99%A8/" rel="tag">浏览器</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95/" rel="tag">面试</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签云</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/JavaScript/" style="font-size: 13.5px;">JavaScript</a> <a href="/tags/Koa/" style="font-size: 13px;">Koa</a> <a href="/tags/Node/" style="font-size: 13.5px;">Node</a> <a href="/tags/React/" style="font-size: 14px;">React</a> <a href="/tags/TypeScript/" style="font-size: 13px;">TypeScript</a> <a href="/tags/Webpack/" style="font-size: 13.5px;">Webpack</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" style="font-size: 13px;">数据结构与算法</a> <a href="/tags/%E6%B5%8F%E8%A7%88%E5%99%A8/" style="font-size: 13px;">浏览器</a> <a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 13px;">面试</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">九月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">八月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">七月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">六月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">五月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">四月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">三月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">二月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">一月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">十二月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">七月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">二月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a>
              </p>
              <p class="item-title">
                <a href="/2022/09/11/front_end/react-concurrent/" class="title">【React源码】React Concurrent模式</a>
              </p>
              <p class="item-date">
                <time datetime="2022-09-10T22:32:08.000Z" itemprop="datePublished">2022-09-10</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a>
              </p>
              <p class="item-title">
                <a href="/2022/08/26/front_end/react-hooks/" class="title">【React源码】React Hooks</a>
              </p>
              <p class="item-date">
                <time datetime="2022-08-25T20:12:49.000Z" itemprop="datePublished">2022-08-25</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a>
              </p>
              <p class="item-title">
                <a href="/2022/08/12/front_end/react-updateState/" class="title">【React源码】React状态更新</a>
              </p>
              <p class="item-date">
                <time datetime="2022-08-11T21:55:32.000Z" itemprop="datePublished">2022-08-11</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a>
              </p>
              <p class="item-title">
                <a href="/2022/07/23/front_end/react-diff/" class="title">【React源码】React diff算法</a>
              </p>
              <p class="item-date">
                <time datetime="2022-07-22T20:02:15.000Z" itemprop="datePublished">2022-07-22</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a>
              </p>
              <p class="item-title">
                <a href="/2022/07/01/front_end/react-commit/" class="title">【React源码】React commit阶段</a>
              </p>
              <p class="item-date">
                <time datetime="2022-06-30T22:33:45.000Z" itemprop="datePublished">2022-06-30</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
  <aside class="sidebar sidebar-toc collapse   in  " id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Node%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.</span> <span class="toc-text">Node的使用场景</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Node-js-%E6%9E%B6%E6%9E%84%EF%BC%88node%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%EF%BC%89"><span class="toc-number">2.</span> <span class="toc-text">Node.js 架构（node底层原理）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Node-EventLoop%EF%BC%88%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%EF%BC%89"><span class="toc-number">3.</span> <span class="toc-text">Node EventLoop（事件循环）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Node%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E5%90%84%E9%98%B6%E6%AE%B5%E6%A6%82%E8%BF%B0"><span class="toc-number">3.1.</span> <span class="toc-text">Node事件循环各阶段概述</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E5%92%8C%E7%BA%BF%E7%A8%8B"><span class="toc-number">4.</span> <span class="toc-text">进程和线程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Node%E6%A8%A1%E5%9D%97%E6%9C%BA%E5%88%B6"><span class="toc-number">5.</span> <span class="toc-text">Node模块机制</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Node%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97"><span class="toc-number">6.</span> <span class="toc-text">Node常用模块</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#process%E5%85%A8%E5%B1%80%E5%AF%B9%E8%B1%A1"><span class="toc-number">6.1.</span> <span class="toc-text">process全局对象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#process-env"><span class="toc-number">6.1.1.</span> <span class="toc-text">process.env</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#child-process%EF%BC%88%E5%88%9B%E5%BB%BA%E5%AD%90%E8%BF%9B%E7%A8%8B%EF%BC%89"><span class="toc-number">6.2.</span> <span class="toc-text">child_process（创建子进程）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#path"><span class="toc-number">6.3.</span> <span class="toc-text">path</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#path-join"><span class="toc-number">6.3.1.</span> <span class="toc-text">path.join()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#path-resove"><span class="toc-number">6.3.2.</span> <span class="toc-text">path.resove()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#basename"><span class="toc-number">6.3.3.</span> <span class="toc-text">basename()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#path-extname"><span class="toc-number">6.3.4.</span> <span class="toc-text">path.extname()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#path-parse"><span class="toc-number">6.3.5.</span> <span class="toc-text">path.parse()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fs-%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6"><span class="toc-number">6.4.</span> <span class="toc-text">fs(读取文件)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#events%EF%BC%88%E4%BA%8B%E4%BB%B6%E6%A8%A1%E5%9D%97%EF%BC%89"><span class="toc-number">6.5.</span> <span class="toc-text">events（事件模块）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Event"><span class="toc-number">6.5.1.</span> <span class="toc-text">Event</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#error%E4%BA%8B%E4%BB%B6"><span class="toc-number">6.5.2.</span> <span class="toc-text">error事件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Buffer%EF%BC%88%E7%BC%93%E5%86%B2%E5%8C%BA%EF%BC%89"><span class="toc-number">6.6.</span> <span class="toc-text">Buffer（缓冲区）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Buffer%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">6.6.1.</span> <span class="toc-text">Buffer应用场景</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Buffer%E4%B8%8E%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E4%BC%A0%E8%BE%93%E9%80%9F%E5%BA%A6"><span class="toc-number">6.7.</span> <span class="toc-text">Buffer与字符串的传输速度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#buffer%E6%A8%A1%E5%9D%97%E4%B8%8EBuffer%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">6.8.</span> <span class="toc-text">buffer模块与Buffer的关系</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BABuffer"><span class="toc-number">6.8.1.</span> <span class="toc-text">创建Buffer</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Buffer-%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81"><span class="toc-number">6.8.1.1.</span> <span class="toc-text">Buffer 字符编码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%B8%8E-Buffer-%E7%B1%BB%E5%9E%8B%E4%BA%92%E8%BD%AC"><span class="toc-number">6.8.2.</span> <span class="toc-text">字符串与 Buffer 类型互转</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BD%AC-Buffer%EF%BC%88%E5%B0%86%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%95%B0%E6%8D%AE%E5%86%99%E5%85%A5%E7%BC%93%E5%86%B2%E5%8C%BA%EF%BC%89"><span class="toc-number">6.8.2.1.</span> <span class="toc-text">字符串转 Buffer（将字符串数据写入缓冲区）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Buffer-%E8%BD%AC%E6%8D%A2%E4%B8%BA%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%88%E4%BB%8E%E7%BC%93%E5%86%B2%E5%8C%BA%E8%AF%BB%E5%8F%96string%E6%95%B0%E6%8D%AE%EF%BC%89"><span class="toc-number">6.8.2.2.</span> <span class="toc-text">Buffer 转换为字符串（从缓冲区读取string数据）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86buffer%E8%BD%AC%E6%8D%A2%E6%88%90JSON%E5%AF%B9%E8%B1%A1"><span class="toc-number">6.8.3.</span> <span class="toc-text">将buffer转换成JSON对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#buffer%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E5%90%88%E5%B9%B6"><span class="toc-number">6.8.4.</span> <span class="toc-text">buffer缓冲区的合并</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E6%8B%B7%E8%B4%9D"><span class="toc-number">6.8.5.</span> <span class="toc-text">缓冲区的拷贝</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E6%AF%94%E8%BE%83"><span class="toc-number">6.8.6.</span> <span class="toc-text">缓冲区的比较</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%86%B2%E5%8C%BA%E7%9A%84%E8%A3%81%E5%89%AA"><span class="toc-number">6.8.7.</span> <span class="toc-text">缓冲区的裁剪</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%AC%E6%8D%A2%E8%BF%87%E7%A8%8B%E4%B8%AD%E4%B8%BA%E4%BB%80%E4%B9%88%E5%87%BA%E7%8E%B0%E4%B9%B1%E7%A0%81%EF%BC%9F"><span class="toc-number">6.8.8.</span> <span class="toc-text">转换过程中为什么出现乱码？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Stream%EF%BC%88%E6%B5%81%EF%BC%89"><span class="toc-number">6.9.</span> <span class="toc-text">Stream（流）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E4%B8%AD%E7%9A%84%E7%BC%93%E5%86%B2%E5%8C%BA"><span class="toc-number">6.9.1.</span> <span class="toc-text">流中的缓冲区</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E8%AF%BB%E6%B5%81"><span class="toc-number">6.9.2.</span> <span class="toc-text">可读流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stream-Readable%E7%B1%BB%E4%BA%8B%E4%BB%B6"><span class="toc-number">6.9.3.</span> <span class="toc-text">stream.Readable类事件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stream-Readable%E7%B1%BB%E6%96%B9%E6%B3%95"><span class="toc-number">6.9.4.</span> <span class="toc-text">stream.Readable类方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%A4%E7%A7%8D%E8%AF%BB%E5%8F%96%E6%A8%A1%E5%BC%8F"><span class="toc-number">6.9.5.</span> <span class="toc-text">两种读取模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E5%86%99%E6%B5%81"><span class="toc-number">6.9.6.</span> <span class="toc-text">可写流</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#stream-Writable%E7%B1%BB%E4%BA%8B%E4%BB%B6"><span class="toc-number">6.9.6.1.</span> <span class="toc-text">stream.Writable类事件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#stream-Writable%E7%B1%BB%E6%96%B9%E6%B3%95"><span class="toc-number">6.9.6.2.</span> <span class="toc-text">stream.Writable类方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8C%E5%B7%A5%E6%B5%81%E4%B8%8E%E8%BD%AC%E6%8D%A2%E6%B5%81"><span class="toc-number">6.9.7.</span> <span class="toc-text">双工流与转换流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8F%8C%E5%B7%A5%E6%B5%81"><span class="toc-number">6.9.8.</span> <span class="toc-text">实现双工流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8C%E5%B7%A5%E6%B5%81%E7%9A%84%E4%BE%8B%E5%AD%90"><span class="toc-number">6.9.9.</span> <span class="toc-text">双工流的例子</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#net%E6%A8%A1%E5%9D%97"><span class="toc-number">6.10.</span> <span class="toc-text">net模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BATCP%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">6.10.1.</span> <span class="toc-text">创建TCP服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BATCP%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">6.10.2.</span> <span class="toc-text">创建TCP服务器示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#server-listen%E7%9B%91%E5%90%AC%E9%93%BE%E6%8E%A5"><span class="toc-number">6.10.3.</span> <span class="toc-text">server.listen监听链接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BASocket%E5%AF%B9%E8%B1%A1%E5%8F%91%E9%80%81%E5%92%8C%E6%8E%A5%E5%8F%97%E6%95%B0%E6%8D%AE"><span class="toc-number">6.10.4.</span> <span class="toc-text">创建Socket对象发送和接受数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E5%BB%BATCP%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">6.10.5.</span> <span class="toc-text">构建TCP客户端</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#http"><span class="toc-number">6.11.</span> <span class="toc-text">http</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#http-Server%E4%BA%8B%E4%BB%B6"><span class="toc-number">6.11.1.</span> <span class="toc-text">http.Server事件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#http-requset%E5%8F%91%E9%80%81%E8%AF%B7%E6%B1%82"><span class="toc-number">6.11.2.</span> <span class="toc-text">http.requset发送请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#http%E8%AF%B7%E6%B1%82%E5%AF%B9%E8%B1%A1%E5%92%8C%E5%93%8D%E5%BA%94%E5%AF%B9%E8%B1%A1"><span class="toc-number">6.11.3.</span> <span class="toc-text">http请求对象和响应对象</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#http-ClientRequest"><span class="toc-number">6.11.3.1.</span> <span class="toc-text">http.ClientRequest</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#http-ServerResponse%E7%B1%BB"><span class="toc-number">6.11.3.2.</span> <span class="toc-text">http.ServerResponse类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#REST-ful%E9%A3%8E%E6%A0%BC"><span class="toc-number">6.11.3.3.</span> <span class="toc-text">REST ful风格</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#npm"><span class="toc-number">7.</span> <span class="toc-text">npm</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#package-json"><span class="toc-number">7.1.</span> <span class="toc-text">package.json</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#npm%E5%91%BD%E4%BB%A4"><span class="toc-number">7.2.</span> <span class="toc-text">npm命令</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#WebSocket"><span class="toc-number">8.</span> <span class="toc-text">WebSocket</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8ws%E5%88%9B%E5%BB%BAWebSocket%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">8.1.</span> <span class="toc-text">使用ws创建WebSocket服务器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ws%E4%BA%8B%E4%BB%B6"><span class="toc-number">8.2.</span> <span class="toc-text">ws事件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E5%92%8C%E6%8E%A5%E6%94%B6%E6%95%B0%E6%8D%AE"><span class="toc-number">8.3.</span> <span class="toc-text">发送和接收数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE"><span class="toc-number">8.3.1.</span> <span class="toc-text">发送数据</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E9%80%81ping%E5%92%8Cpong"><span class="toc-number">8.3.1.1.</span> <span class="toc-text">发送ping和pong</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E6%94%B6%E6%95%B0%E6%8D%AE"><span class="toc-number">8.3.1.2.</span> <span class="toc-text">接收数据</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E7%8A%B6%E6%80%81"><span class="toc-number">8.3.2.</span> <span class="toc-text">准备状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%97%ADWebSocket%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">8.3.3.</span> <span class="toc-text">关闭WebSocket服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ws%E4%BE%8B%E5%AD%90"><span class="toc-number">8.3.4.</span> <span class="toc-text">ws例子</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MySQL%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="toc-number">9.</span> <span class="toc-text">MySQL基本操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8node-js%E6%93%8D%E4%BD%9Cmysql"><span class="toc-number">9.1.</span> <span class="toc-text">使用node.js操作mysql</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84%E6%9F%A5%E8%AF%A2"><span class="toc-number">9.2.</span> <span class="toc-text">实现简单的查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mysql%E6%A8%A1%E5%9D%97%E8%BF%9E%E6%8E%A5%E9%80%89%E9%A1%B9"><span class="toc-number">9.2.1.</span> <span class="toc-text">mysql模块连接选项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mysql%E6%A8%A1%E5%9D%97CRUD"><span class="toc-number">9.2.2.</span> <span class="toc-text">mysql模块CRUD</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql%E8%BF%9E%E6%8E%A5%E6%B1%A0"><span class="toc-number">9.3.</span> <span class="toc-text">mysql连接池</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis"><span class="toc-number">10.</span> <span class="toc-text">Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Redis%E8%B6%85%E6%97%B6"><span class="toc-number">10.1.</span> <span class="toc-text">Redis超时</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#node-js%E6%93%8D%E4%BD%9Credis"><span class="toc-number">10.2.</span> <span class="toc-text">node.js操作redis</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">11.</span> <span class="toc-text">异常处理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E5%B4%A9%E6%BA%83%E6%97%B6%E9%87%8D%E5%90%AF"><span class="toc-number">11.1.</span> <span class="toc-text">进程崩溃时重启</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%A7%E9%9B%86%E7%BE%A4%EF%BC%9A%E5%A4%9A%E5%8F%B0%E6%9C%BA%E5%99%A8"><span class="toc-number">11.2.</span> <span class="toc-text">大集群：多台机器</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">12.</span> <span class="toc-text">参考</span></a></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-front_end/node-base" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Node 知识梳理（一）
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2022/01/06/front_end/node-base/" class="article-date">
	  <time datetime="2022-01-05T22:15:33.000Z" itemprop="datePublished">2022-01-05</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link-link" href="/tags/Node/" rel="tag">Node</a>
  </span>


        

	<span class="article-read hidden-xs">
    	<i class="icon icon-eye-fill" aria-hidden="true"></i>
    	<span id="/2022/01/06/front_end/node-base/" class="leancloud_visitors"  data-flag-title="Node 知识梳理（一）">
			<span class="leancloud-visitors-count">0</span>
		</span>
    </span>

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2022/01/06/front_end/node-base/#comments" class="article-comment-link">评论</a></span>
        
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <ul>
<li>Node 是一个基于谷歌V8引擎的一个JavaScript运行环境（runtime运行时），是服务端的运行环境。</li>
<li>Node 的特点是事件驱动、非阻塞式 I&#x2F;O（input&#x2F;output）、单线程。触发一次事件，执行回调，是事件驱动的一种体现。</li>
</ul>
<h1 id="Node的使用场景"><a href="#Node的使用场景" class="headerlink" title="Node的使用场景"></a>Node的使用场景</h1><ul>
<li>I&#x2F;O 密集型场景</li>
<li>提供http接口，组装数据</li>
<li>RPC服务，RPC（Remote Procedure Call远程过程调用），RPC服务也是采用的TCP，出名的RPC服务有Google的gRPC、阿里的Dubble</li>
<li>基础工具：构建工具（webpack、vite）、搭建脚手架（cra、vue-cli、umi）等</li>
<li>BFF：接口聚合、转发</li>
<li>Serverless（无服务器架构）：函数即服务，写一个函数就可以实现一个 API 接口给到前端</li>
<li>Microservices（微服务）：小型服务、以独立进程运行、可以使用不同语言</li>
</ul>
<h1 id="Node-js-架构（node底层原理）"><a href="#Node-js-架构（node底层原理）" class="headerlink" title="Node.js 架构（node底层原理）"></a>Node.js 架构（node底层原理）</h1><ol>
<li>Node.js内置模块（标准库）： http、fs、buffer、path、stream。</li>
<li>Node bindings（桥梁）：是JavaScript与 C++ 连接的桥梁，对底层模块进行封装，为内置模块的提供 API 接口。</li>
<li>Node底层模块</li>
</ol>
<ul>
<li>V8：Google开源的高性能JavaScript引擎，使用 C++ 开发，并且应用于谷歌浏览器</li>
<li>Libuv：提供Event Loop 事件循环和线程池，提供事件驱动的 I&#x2F;O 库。它是使用 C 和 C++ 语言为 Node.js 所开发的，同时也是 I&#x2F;O 操作的核心部分，例如读取文件和 OS 交互（几乎所有和操作系统打交道的部分离不开libuv的支持）</li>
<li>C-ares（异步 DNS 解析库）</li>
<li>Low-Level Components：提供了http 解析、OpenSSL、数据压缩（zlib）等功能。</li>
</ul>
<h1 id="Node-EventLoop（事件循环）"><a href="#Node-EventLoop（事件循环）" class="headerlink" title="Node EventLoop（事件循环）"></a>Node EventLoop（事件循环）</h1><p>node中的事件循环的顺序：<br>外部输入数据(incoming) –&gt; 轮询阶段(poll) –&gt; 检查阶段(check)–&gt; 关闭事件回调阶段(close callbacks) –&gt; 定时器检测阶段(timers) –&gt; I&#x2F;O事件回调阶段(I&#x2F;O callbacks) –&gt; 闲置阶段(idle, prepare) –&gt; 轮询阶段(按照该顺序反复运行)</p>
<p>每个阶段都有一个先入先出的队列，这个队列存有要执行的回调函数</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">   ┌───────────────────────────┐
┌─<span class="token operator">></span>│           timers          │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
│  │     <span class="token constant">I</span><span class="token operator">/</span><span class="token constant">O</span> callbacks         │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
│  │       idle<span class="token punctuation">,</span> prepare       │
│  └─────────────┬─────────────┘      ┌───────────────┐
│  ┌─────────────┴─────────────┐      │   incoming<span class="token operator">:</span>   │
│  │           poll            │<span class="token operator">&lt;</span>─────┤  connections<span class="token punctuation">,</span> │
│  └─────────────┬─────────────┘      │   data<span class="token punctuation">,</span> etc<span class="token punctuation">.</span>  │
│  ┌─────────────┴─────────────┐      └───────────────┘
│  │           check           │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
└──┤      close callbacks      │
   └───────────────────────────┘<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Node事件循环各阶段概述"><a href="#Node事件循环各阶段概述" class="headerlink" title="Node事件循环各阶段概述"></a>Node事件循环各阶段概述</h2><p>绝大部分异步任务都是在timers、poll、check这3个阶段处理的。</p>
<ol>
<li>timers 这个阶段执行 setTimeout() 和 setInterval() 的回调，并且是由 poll 阶段控制的。 在 Node 中定时器指定的时间也不是准确时间，只能是尽快执行，如果操作系统很忙，那么计时器的回调函数就会被推迟执行</li>
<li>I&#x2F;O callbacks 处理一些上一轮循环中的少数未执行的 I&#x2F;O 回调（执行一些系统操作的回调函数）</li>
<li>闲置阶段：idle（空闲），prepare 仅在内部使用。</li>
<li>poll（轮询阶段）：处理大部分的事件，如看看有没有文件可以读，有没有请求可以处理，检查一下最近的计时器，看看有没有需要过会儿去执行的 callback。poll 是一个至关重要的阶段，这一阶段中，系统会做两件事情</li>
</ol>
<ul>
<li>回到 timer 阶段执行回调</li>
<li>执行 I&#x2F;O 回调</li>
</ul>
<p>并且在进入该阶段时如果没有设定了 timer 的话，会发生以下两件事情</p>
<ul>
<li><p>如果 poll 队列不为空，会遍历回调队列并同步执行，直到队列为空或者达到系统限制</p>
</li>
<li><p>如果 poll 队列为空时，会有两件事发生</p>
<ul>
<li>如果有 setImmediate 回调需要执行，poll 阶段会停止并且进入到 check 阶段执行回调</li>
<li>如果没有 setImmediate 回调需要执行，会等待回调被加入到队列中并立即执行回调，这里同样会有个超时时间设置防止一直等待下去</li>
</ul>
</li>
</ul>
<ol start="5">
<li>check（检查） 执行 setImmediate() 的回调</li>
<li>close callbacks 执行 socket 的 close 事件回调，例如：<code>socket.on(&#39;close&#39;, ...)</code>，如果队列是空的，则跳过</li>
</ol>
<p>Node 不会一直循环循环，如果发现没什么事儿做，就会停留在 poll（轮询）阶段，大部分事件都在 poll 阶段被处理，如文件、网络请求等</p>
<h1 id="进程和线程"><a href="#进程和线程" class="headerlink" title="进程和线程"></a>进程和线程</h1><ol>
<li>进程</li>
</ol>
<ul>
<li>进程可以说是计算机系统进行资源分配和调度的基本单位，启动一个服务、运行一个应用，就是开一个进程，进程是线程的容器。</li>
<li>例如 Java 里的 JVM 本身就是一个进程，Node.js 里通过 node app.js 开启一个服务进程。在任务管理器查看任务进程，Nodejs JavaScript Runtime<img src="/images/front_end/nodejs-runtime001.png" ></li>
<li>一个进程无法访问另外一个进程里定义的变量、数据结构，只有建立了 IPC 通信，进程之间才可数据共享。</li>
<li>同一块代码，可以根据系统CPU核心数启动多个进程，每个进程都有属于自己的独立运行空间，进程之间是不相互影响的。</li>
</ul>
<ol start="2">
<li>线程</li>
</ol>
<ul>
<li>线程是属于进程的，进程可以调用线程去执行一些子任务，一个进程是可以拥有多个线程的。</li>
<li>同一进程中的多条线程可以共享该进程中的全部系统资源。</li>
<li>同一进程中的多个线程有各自的调用栈（call stack），本地存储（thread-local storage)等。</li>
<li>线程可以分为单线程（JavaScript）和多线程（Java）。</li>
</ul>
<ol start="3">
<li>单线程</li>
</ol>
<ul>
<li>单线程就是一个进程只开一个线程，Javascript 就是属于单线程，程序顺序执行，前面一个执行完之后，后面才可以执行。</li>
<li>在使用单线程编码时不要有过多耗时的同步操作，否则线程会造成阻塞，导致后续响应无法处理，适当地使用异步操作。</li>
</ul>
<ol start="4">
<li>多线程</li>
</ol>
<ul>
<li>多线程就是，一个进程可以开启多线程，Java 就是多线程编程语言的一种，可以有效避免代码阻塞导致的后续请求无法处理。</li>
<li>多线程创建新的线程来切换开销，由于每创建一个线程就会占用一定的内存，当应用程序并发大了之后，内存将会很快耗尽。</li>
</ul>
<h1 id="Node模块机制"><a href="#Node模块机制" class="headerlink" title="Node模块机制"></a>Node模块机制</h1><ol>
<li>Node.js 模块采用Commonjs规范，Node.js的系统模块采用了延迟加载的策略，只有在用到的情况下，系统模块才会被加载，加载完成后会放到 binding_cache缓存中。</li>
<li>在 Node.js 中模块加载一般会经历 3 个步骤，路径分析、文件定位、编译执行。按照模块的分类，按照以下顺序进行优先加载：</li>
</ol>
<ul>
<li>如果有 <code>./</code>从当前目录查找，相对路径文件模块</li>
<li>如果没有 <code>./</code>，先从系统模块，再从node_modules下查找 （<a target="_blank" rel="noopener" href="https://blog.csdn.net/gongch0604/article/details/111748684">nodejs模块系统</a>）</li>
<li>系统缓存：模块被执行之后会进行缓存，首先是先进行缓存加载，判断缓存中是否有值（require.cache查看已缓存的模块，返回值为对象）。因为 Node.js 默认先从缓存中加载模块，一个模块被加载一次之后，就会在缓存中维持一个副本，如果遇到重复加载的模块会直接提取缓存中的副本，也就是说在任何时候每个模块都只在缓存中有一个实例。</li>
<li>系统模块：也就是原生模块，这个优先级仅次于缓存加载，部分核心模块已经被编译成二进制，省略了 路径分析、文件定位，直接加载到了内存中，系统模块定义在 Node.js 源码的 lib 目录下，可以去查看。</li>
<li>文件模块（开发者自己编写的模块）：优先加载 <code>.</code>、<code>..</code>、<code>/</code> 开头的，如果文件没有加上扩展名，会依次按照 <code>.js</code>、<code>.json</code>、<code>.node</code> 进行扩展名补足尝试，那么在尝试的过程中也是以同步阻塞模式来判断文件是否存在，从性能优化的角度来看待，<code>.json</code>、<code>.node</code>最好还是加上文件的扩展名。</li>
<li>目录做为模块：这种情况发生在文件模块加载过程中，也没有找到，但是发现是一个目录的情况，这个时候会将这个目录当作一个包来处理，Node 这块采用了 Commonjs 规范，先会在项目根目录查找 package.json 文件，取出文件中定义的 main 属性 <code>(&quot;main&quot;: &quot;lib/index.js&quot;)</code> 描述的入口文件进行加载，也没加载到，则会抛出默认错误: <code>Error: Cannot find module &#39;lib/index.js&#39;</code></li>
<li>node_modules 目录加载：对于系统模块、路径文件模块都找不到，Node.js 会从当前模块的父目录进行查找，直到系统的根目录</li>
</ul>
<h1 id="Node常用模块"><a href="#Node常用模块" class="headerlink" title="Node常用模块"></a>Node常用模块</h1><table>
<thead>
<tr>
<th align="center">模块名称</th>
<th align="center">功能描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">buffer</td>
<td align="center">实现数据缓冲区，Buffer一般用于处理二进制数据，也可以处理字符编码</td>
</tr>
<tr>
<td align="center">child_process</td>
<td align="center">（实现多进程任务）创建子进程，实现子进程和主进程之间的通信</td>
</tr>
<tr>
<td align="center">cluster</td>
<td align="center">可以简化<code>多进程</code>、<code>并行化</code>程序的开发难度，利用多核CPU 实现并行，轻松构建一个用于负载均衡的集群。著名的pm2模块就使用了cluster实现</td>
</tr>
<tr>
<td align="center">console</td>
<td align="center">和浏览里的用法一样，比如console.log、console.dir等</td>
</tr>
<tr>
<td align="center">crypto</td>
<td align="center">对OpenSSL里的 HMAC、Cipher、Decipher等算法进行加解密封装，一般用户在进行密码处理时都会用到该模块</td>
</tr>
<tr>
<td align="center">dns</td>
<td align="center">域名解析，主要API是 lookup和 resolve</td>
</tr>
<tr>
<td align="center">events</td>
<td align="center">事件处理，EventEmitter的核心功能就是对事件触发和事件监听器功能进行封装</td>
</tr>
<tr>
<td align="center">fs</td>
<td align="center">文件系统模块，主要针对目录、文件进行操作，开发中使用极其广泛</td>
</tr>
<tr>
<td align="center">http</td>
<td align="center">Node.js里使用多的模块，可以非常构建Web应用服务，搭建HTTP服务端和客户端，是Web框架的底层核心库</td>
</tr>
<tr>
<td align="center">http2</td>
<td align="center">下一代HTTP协议，在Node.js 8里是需要通过flag开启的体验功能</td>
</tr>
<tr>
<td align="center">https</td>
<td align="center">HTTPS实现，是HTTP的安全加强版</td>
</tr>
</tbody></table>
<h2 id="process全局对象"><a href="#process全局对象" class="headerlink" title="process全局对象"></a>process全局对象</h2><p>Node.js 中的进程 process 是一个全局对象，无需 require 直接使用（global.process &#x3D; process），process对象是EventEmitter的实例</p>
<ul>
<li>process.title：终端上显示的标题</li>
<li>process.version：nodejs的版本号</li>
<li>process.versions：nodejs依赖模块的版本信息</li>
<li>process.env：环境变量，例如通过 <code>process.env.NODE_ENV</code> 获取不同环境项目配置信息，还可以往<code>process.env</code>上挂载其他常量。</li>
<li>process.nextTick：表示在事件循环（EventLoop）的下一次循环中调用 callback 回调函数，要注意的是它总会在I&#x2F;O操作（比如查询数据）之前先执行</li>
<li>process.pid：获取当前进程id</li>
<li>process.ppid：当前进程对应的父进程</li>
<li>process.cwd()：获取当前进程工作目录</li>
<li>process.argv: 返回当前命令行指令参数，是一个数组，<code>process.argv[2]</code></li>
<li>process.execPath：获取当前进程的这个可执行文件的绝对路径</li>
<li>process.exit([code])：终止当前进程并返回给定的 code，默认是0</li>
<li>process.exitCode：可以自定义退出进程时node shell捕获到的状态码（可以自定义退出进程时node shell捕获到的状态码）</li>
<li>process.chdir(directory)：改变进程的当前进程的工作目录（该目录必须已存在），若操作失败则抛出异常</li>
<li>process.platform：获取当前进程运行的操作系统平台</li>
<li>process.uptime()：当前进程已运行时间，例如：pm2 守护进程的 uptime 值</li>
<li>process.moduleLoadList：当前进程已加载的模块列表，nodejs模块系统。NativeModule原生模块</li>
<li>process.config：当前nodejs构建时使用的配置信息，可以辅助定位</li>
<li><code>process.on(&#39;exit&#39;, callback)</code>：当进程将要退出时触发。 ‘exit’的回调结束后，主进程将不再运行</li>
<li><code>process.on(&#39;SIGINT&#39;, callback)</code>：捕获当前进程接收到的信号</li>
<li>process.abort()：触发node的abort事件，退出当前进程，执行该函数后，后面的代码不执行。</li>
<li><code>process.kill(pid, [signal])</code>：结束对应某pid的进程并发送一个信号</li>
<li>进程事件：<code>process.on(&#39;uncaughtException&#39;, cb)</code> 捕获异常信息、<code>process.on(&#39;exit&#39;, cb)</code>进程推出监听</li>
<li>三个标准流：process.stdout 标准输出、process.stdin 标准输入、process.stderr 标准错误输出</li>
</ul>
<h3 id="process-env"><a href="#process-env" class="headerlink" title="process.env"></a>process.env</h3><p>process.env属性返回一个包含用户环境信息的对象。在node环境中，当我们打印process.env时，发现它并没有NODE_ENV这一个属性。实际上，process.env.NODE_ENV是在package.json的scripts命令中注入的，也就是NODE_ENV并不是node自带的，而是由用户定义的，至于为什么叫NODE_ENV，应该是约定成俗的吧。</p>
<h2 id="child-process（创建子进程）"><a href="#child-process（创建子进程）" class="headerlink" title="child_process（创建子进程）"></a>child_process（创建子进程）</h2><p>Node.js 提供了 child_process 内置模块，用于创建子进程</p>
<ul>
<li>child_process.spawn()：适用于返回大量数据，例如图像处理，二进制数据处理。</li>
<li>child_process.exec()：适用于小量数据，maxBuffer 默认值为 200 * 1024 超出这个默认值将会导致程序崩溃，数据量过大可采用 spawn。</li>
<li>child_process.execFile()：类似 child_process.exec()，区别是不能通过 shell 来执行，不支持像 I&#x2F;O 重定向和文件查找这样的行为</li>
<li>child_process.fork()：衍生新的进程，进程之间是相互独立的，每个进程都有自己的 V8 实例、内存，系统资源是有限的，不建议衍生太多的子进程出来，通长根据系统 CPU 核心数设置。</li>
</ul>
<h2 id="path"><a href="#path" class="headerlink" title="path"></a>path</h2><p>主要作用就是处理文件的目录和路径，在前端项目webpack配置文件中经常用到。</p>
<h3 id="path-join"><a href="#path-join" class="headerlink" title="path.join()"></a>path.join()</h3><p>拼接多个路径片段，还原成完整可用路径</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'a/b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token string">'index.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// a/b/c/index.html</span>
path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'/a/b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token string">'index.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// /a/b/c/index.html</span>
path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'a/b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token string">'../'</span><span class="token punctuation">,</span> <span class="token string">'index.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// a/b/index.html</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="path-resove"><a href="#path-resove" class="headerlink" title="path.resove()"></a>path.resove()</h3><p>返回一个绝对路径</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">path<span class="token punctuation">.</span><span class="token function">resove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取绝对路径</span>
path<span class="token punctuation">.</span><span class="token function">resove</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token string">'index.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="basename"><a href="#basename" class="headerlink" title="basename()"></a>basename()</h3><p>获取路径中基础名称</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>__filename<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// test.js</span>
<span class="token comment">// 传入第二个参数如果匹配会省略后缀，不匹配仍旧返回真实的后缀</span>
path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>__filename<span class="token punctuation">,</span> <span class="token string">'.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// test</span>
path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token string">'/a/b/c'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// c</span>
path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token string">'/a/b/c/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// c</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="path-extname"><a href="#path-extname" class="headerlink" title="path.extname()"></a>path.extname()</h3><p>获取路径中的扩展名称</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span><span class="token string">'/src/index.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// .html</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="path-parse"><a href="#path-parse" class="headerlink" title="path.parse()"></a>path.parse()</h3><p>解析路径</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> obj <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">'/src/index.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/**
* root: /
* dir: /src
* base: index.html
* ext: .html
* name: index
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="fs-读取文件"><a href="#fs-读取文件" class="headerlink" title="fs(读取文件)"></a>fs(读取文件)</h2><h2 id="events（事件模块）"><a href="#events（事件模块）" class="headerlink" title="events（事件模块）"></a>events（事件模块）</h2><ul>
<li>在 Node.js 中一个很重要的模块 Events（EventEmitter 事件触发器），EventEmitter 本质上就是观察者模式的实现。net、http、fs、stream、process 等模块，express、koa 框架都依赖了Events。</li>
<li>EventEmitter 对象的事件触发 emit 和监听 on 是同步的，事件的回调是异步的。</li>
<li>在 Node.js 的事件机制中主要有三类角色: 事件(Event)、事件发射器(EventEmitter)、事件监听器(Event Listener)。</li>
</ul>
<h3 id="Event"><a href="#Event" class="headerlink" title="Event"></a>Event</h3><ul>
<li><p>EventEmitter 提供了 <code>on()</code>、<code>once()</code>、<code>removeListener()</code> 等方法来对事件进行监听移除，可同时注册多个同名的事件。其中<code>once()</code>: 当触发多次相同名称事件，通过 once 添加的侦听器只会执行一次。</p>
</li>
<li><p>EventEmitter 会按照监听器注册的顺序<strong>同步</strong>地调用所有监听器，所以必须确保事件的排序正确。提前触发未监听的事件，不会报错，并且不会执行监听的回调函数。</p>
</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 基本使用</span>
<span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>EventEmitter<span class="token punctuation">;</span>
<span class="token keyword">const</span> emitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
emitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"起床"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">早上 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>time<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> 开始起床，新的一天加油！</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
emitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">"起床"</span><span class="token punctuation">,</span> <span class="token string">"6:00"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 在 Koa 中 new 一个 app 对象，通过 app.emit() 触发一个事件，实现在整个系统中进行传递。</span>
<span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"koa"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"在 Koa 中使用 EventEmitter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">"koa"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 通过Object.setPrototypeOf() 来实现的继承</span>
<span class="token keyword">function</span> <span class="token function">MyEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">EventEmitter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
Object<span class="token punctuation">.</span><span class="token function">setPrototypeOf</span><span class="token punctuation">(</span><span class="token class-name">MyEmitter</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
Object<span class="token punctuation">.</span><span class="token function">setPrototypeOf</span><span class="token punctuation">(</span>MyEmitter<span class="token punctuation">,</span> EventEmitter<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>默认情况下，如果为特定事件添加了超过 10 个监听器，则 EventEmitter 会打印一个警告。 但是，并不是所有的事件都要限制 10 个监听器。 <code>emitter.setMaxListeners()</code> 方法可以为指定的 EventEmitter 实例修改限制。</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 操作最大事件监听个数</span>
<span class="token comment">// 设置同类型事件监听最大个数</span>
<span class="token class-name">EventEmitter</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">setMaxListeners</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">count</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_count <span class="token operator">=</span> count<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 获取同类型事件监听最大个数</span>
<span class="token class-name">EventEmitter</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">getMaxListeners</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_count <span class="token operator">||</span> EventEmitter<span class="token punctuation">.</span>defaultMaxListeners<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="error事件"><a href="#error事件" class="headerlink" title="error事件"></a>error事件</h3><p>当EventEmitter 实例出错时，应该触发error事件。如果没有为error事件注册监听器，则当error事件触发时，会抛出错误、打印堆栈跟踪，并退出Node.js进程。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span> <span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">MyEmitter</span> <span class="token keyword">extends</span> <span class="token class-name">EventEmitter</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token keyword">const</span> myEmitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyEmitter</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 模拟触发error事件</span>
myEmitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'错误信息'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 抛出错误</span>

myEmitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Buffer（缓冲区）"><a href="#Buffer（缓冲区）" class="headerlink" title="Buffer（缓冲区）"></a>Buffer（缓冲区）</h2><ul>
<li>Buffer 用于读取或操作二进制数据流，将数据缓冲起来，它是临时性的，对于流式数据，会采用缓冲区将数据临时存储起来。</li>
<li>如用于操作网络协议、数据库、图片和文件I&#x2F;O 等一些需要大量二进制数据的场景，专门存放二进制数据的缓存区。</li>
<li>Buffer 作为存在于全局对象上，使用时无需 require 引入模块即可使用。</li>
<li>Buffer 在创建时大小已经被确定且是无法调整的，在内存分配这块 Buffer 是由 C++ 层面提供而不是 V8。</li>
</ul>
<h3 id="Buffer应用场景"><a href="#Buffer应用场景" class="headerlink" title="Buffer应用场景"></a>Buffer应用场景</h3><p>Buffer的应用场景有以下几种。</p>
<ul>
<li>在使用net或 http模块来接收网络数据时，可用 Buffer作为数据结构进行传输，即 data事件的参数。</li>
<li>用于大文件的读取和写入。以前fs读取的内容是string，后来都改用Buffer，在大文件读取上，性能和内存有明显优势。</li>
<li>用于字符转码、进制转换。Unicode 编码虽然能满足绝大部分场景，但有时候还是不够的，由于Node.js内置的转换编码并不支持GBK，因此如果要处理编码为GBK的文档，就需要iconv和 iconv-lite来补充一部分，string decoder模块提供了一个 API，用于把 Buffer对象解码成字符串，但会保留编码过的多字节UTF-8与UTF-16字符。</li>
<li>用作数据结构，处理二进制数据，也可以处理字符编码。</li>
</ul>
<h2 id="Buffer与字符串的传输速度"><a href="#Buffer与字符串的传输速度" class="headerlink" title="Buffer与字符串的传输速度"></a>Buffer与字符串的传输速度</h2><p>buffer比string快。在 HTTP 传输中传输的是二进制数据，上面例子中的 &#x2F;string 接口直接返回的字符串，这时候 HTTP 在传输之前会先将字符串转换为 Buffer 类型，以二进制数据传输，通过流（Stream）的方式一点点返回到客户端。但是直接返回 Buffer 类型，则少了每次的转换操作，对于性能也是有提升的。在一些 Web 应用中，对于静态数据可以预先转为 Buffer 进行传输，可以有效减少 CPU 的重复使用（重复的字符串转 Buffer 操作）。</p>
<h2 id="buffer模块与Buffer的关系"><a href="#buffer模块与Buffer的关系" class="headerlink" title="buffer模块与Buffer的关系"></a>buffer模块与Buffer的关系</h2><p>Buffer是全局global上的一个引用，指向的其实是buffer.Buffer</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> buffer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'buffer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span>Buffer <span class="token operator">===</span> Buffer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="创建Buffer"><a href="#创建Buffer" class="headerlink" title="创建Buffer"></a>创建Buffer</h3><ul>
<li>Buffer.from()，第一个参数是内容，第二个是按什么格式转。Buffer.from不支持传入数字，传入数字可以采用传入数组的，存入的一组数据最好是：全部落在0到255区间  或者全部落在-128到127，这是因为不同的数字读取时应该调用不同的方法。<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token number">1234</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// throw new errors.TypeError</span>

<span class="token keyword">const</span> buf <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  &lt;Buffer 01 02 03 04>  显示的是16进制的</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li>
<li>Buffer.alloc()，第一个参数是长度，第二个具体buffer内容<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> b2 <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 创建一个大小为 10 个字节的缓冲区</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;Buffer 00 00 00 00 00 00 00 00 00 00></span>

<span class="token comment">// 尝试分配一个大小为 2048 的 Buffer 对象</span>
Buffer<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span>

<span class="token comment">// 打印buffer，将每个字符串对应的ASCII码的十进制，转化为16进制的，比如 H</span>
<span class="token string">'H'</span><span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// ASCII码：'72'</span>
<span class="token string">'H'</span><span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token comment">// '72'的16进制 '48'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h4 id="Buffer-字符编码"><a href="#Buffer-字符编码" class="headerlink" title="Buffer 字符编码"></a>Buffer 字符编码</h4><p>通过使用字符编码，可实现 Buffer 实例与 JavaScript 字符串之间的相互转换。如果不传递 encoding 默认按照 UTF-8 格式转换存储</p>
<ul>
<li><code>&#39;ascii&#39;</code>仅适用于 7 位 ASCII 数据，此编码速度很快，如果设置则会剥离高位。</li>
<li><code>&#39;utf8&#39;</code>多字节编码的 Unicode 字符，许多网页和其他文档格式都使用 UTF-8。</li>
<li><code>&#39;base64&#39;</code>Base64 编码。。</li>
<li><code>&#39;binary&#39;</code>一种将 Buffer 编码成单字节编码字符串的方法。</li>
<li><code>&#39;hex&#39;</code>将每个字节编码成两个十六进制的字符。<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> buf <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'hello world'</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 68656c6c6f20776f726c64</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// hello world</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h3 id="字符串与-Buffer-类型互转"><a href="#字符串与-Buffer-类型互转" class="headerlink" title="字符串与 Buffer 类型互转"></a>字符串与 Buffer 类型互转</h3><h4 id="字符串转-Buffer（将字符串数据写入缓冲区）"><a href="#字符串转-Buffer（将字符串数据写入缓冲区）" class="headerlink" title="字符串转 Buffer（将字符串数据写入缓冲区）"></a>字符串转 Buffer（将字符串数据写入缓冲区）</h4><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> b3 <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'123456789'</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b3<span class="token punctuation">)</span> <span class="token comment">// &lt;Buffer 31 32 33 34 35 36 37 38 39></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b3<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token comment">// 9</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h4 id="Buffer-转换为字符串（从缓冲区读取string数据）"><a href="#Buffer-转换为字符串（从缓冲区读取string数据）" class="headerlink" title="Buffer 转换为字符串（从缓冲区读取string数据）"></a>Buffer 转换为字符串（从缓冲区读取string数据）</h4><p>使用 buf.toString([encoding], [start], [end]) 方法，默认编码仍为 UTF-8</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> b3 <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'123456789'</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b3<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 123456789</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b3<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 1234</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="将buffer转换成JSON对象"><a href="#将buffer转换成JSON对象" class="headerlink" title="将buffer转换成JSON对象"></a>将buffer转换成JSON对象</h3><p>buf.toJSON()，返回一个JSON对象。当字符串化一个buffer实例是，JSON.stringify()会隐式地调用该toJSON()。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> buf <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0x1</span><span class="token punctuation">,</span> <span class="token number">0x2</span><span class="token punctuation">,</span> <span class="token number">0x3</span><span class="token punctuation">,</span> <span class="token number">0x4</span><span class="token punctuation">,</span> <span class="token number">0x5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> json <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 输出: &#123; "type": "Buffer", "data": [ 1,2,3,4,5] &#125;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> copy <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=></span><span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> value <span class="token operator">&amp;&amp;</span> value<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'Buffer'</span> <span class="token operator">?</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">:</span>value<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 输出:&lt;Buffer 01 02 03 04 05></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>copy<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="buffer缓冲区的合并"><a href="#buffer缓冲区的合并" class="headerlink" title="buffer缓冲区的合并"></a>buffer缓冲区的合并</h3><p>Buffer.concat(list[, totalLength])</p>
<ul>
<li>list &lt;Buffer[]&gt; 要连接的 Buffer。</li>
<li>totalLength <code>&lt;integer&gt;</code> 连接时list中Buffer 实例的总长度，如果未提供 totalLength，则从 list 中的 Buffer 实例通过相加其长度来计算</li>
<li>返回: <code>&lt;Buffer&gt;</code></li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> buf1 <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> buf2 <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> buf3 <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> totalLength <span class="token operator">=</span> buf1<span class="token punctuation">.</span>length <span class="token operator">+</span> buf2<span class="token punctuation">.</span>length <span class="token operator">+</span> buf3<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>totalLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 打印: 42</span>
<span class="token keyword">const</span> bufA <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span>buf1<span class="token punctuation">,</span> buf2<span class="token punctuation">,</span> buf3<span class="token punctuation">]</span><span class="token punctuation">,</span> totalLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bufA<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 打印: &lt;Buffer 00 00 00 00 ...></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bufA<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 打印: 42</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="缓冲区的拷贝"><a href="#缓冲区的拷贝" class="headerlink" title="缓冲区的拷贝"></a>缓冲区的拷贝</h3><p>Buffer.copy(buf)</p>
<h3 id="缓冲区的比较"><a href="#缓冲区的比较" class="headerlink" title="缓冲区的比较"></a>缓冲区的比较</h3><p>Buffer.compare(buf1, buf2)</p>
<h3 id="缓冲区的裁剪"><a href="#缓冲区的裁剪" class="headerlink" title="缓冲区的裁剪"></a>缓冲区的裁剪</h3><ul>
<li>buf.slice([start[, end]])</li>
<li>返回一个新的缓冲区，它和旧缓冲区指向同一块内存，但是从索引 start 到 end 的位置剪切</li>
</ul>
<h3 id="转换过程中为什么出现乱码？"><a href="#转换过程中为什么出现乱码？" class="headerlink" title="转换过程中为什么出现乱码？"></a>转换过程中为什么出现乱码？</h3><p>字符串中有中文，一个中文在UTF-8下占用3个字节。转成buffer后，再从buffer转成字符串时，如果字符被截断则容易出现乱码。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> buf <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'前端开发'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// &lt;Buffer e5 89 8d e7 ab af e5 bc 80 e5 8f 91></span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 12，一个中文在UTF-8下占用3个字节</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'UTF-8'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 前端�</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Stream（流）"><a href="#Stream（流）" class="headerlink" title="Stream（流）"></a>Stream（流）</h2><p>Stream在 Node.js 中继承自EventEmitter，它有4种基本流类型。</p>
<ul>
<li>Readable: 可读操作类型，可以产出数据，这些数据可以被传送到其他流中，只需要调用pipe方法即可。</li>
<li>Writable: 可写操作类型，只能流进不能流出。</li>
<li>Duplex: 可读可写操作类型（net.Socket）。</li>
<li>Transform: 转换类型，可以写入数据，然后读出结果。</li>
</ul>
<p>node.js创建的流都是运作在字符串和buffer上的。<br>Stream作为读写方法是最好的。可写流和可读流都会在内部的缓冲区中存储数据，可以分别使用 writable.writableBuffer 或 readable.readableBuffer 来获取。</p>
<h3 id="流中的缓冲区"><a href="#流中的缓冲区" class="headerlink" title="流中的缓冲区"></a>流中的缓冲区</h3><ul>
<li><p>可写流和可读流都会在内部的缓冲区中存储数据，可以 writable.writableBuffer 或 readable.readableBuffer 来获取。</p>
</li>
<li><p>可缓冲的数据大小取决于传入流构造函数的 highWaterMark 选项。对于普通的流，highWaterMark 指定了字节的总数。对于对象模式的流，highWaterMark 指定了对象的总数。</p>
</li>
<li><p>当调用 stream.push(chunk) 时，数据会缓冲在可读流中。如果流的消费者没有调用 stream.read()，则数据会保留在内部队列中直到被消费。</p>
</li>
<li><p>一旦内部的可读缓冲的总大小达到 highWaterMark 指定的或值时，流会停止从底层资源读取数据，直到当前缓冲的数据被消贺（也就是说，流会停止调用内部的用于填充可读缓冲的 readable._read())。</p>
</li>
<li><p>当调用 writable.write(chunk）时，数据会被缓冲在可写流中。当内部的缓冲区的总大小小于 highWaterMark 设置的阈值时，调用 writable.write() 会返回true。一旦内部缓冲的大小达到或超过 highWaterMark 时，则会返回false。</p>
</li>
</ul>
<p>因为双工流和转换流都是可读又可写的，所以它们各自维护着两个相互独立的内部缓冲区用于读取和写入，这使得它们在维护数据流时，读取和写入两边可以各自独立地运作。例如，net.Socket实例是双工流，它的可读端可以消费从socket接收的数据，而可写端则可以将数据写入到socket。因为数据写入到socket的速度可能比接收数据的速度快或慢，所以在读写两端独立地进行操作（或缓冲）就显得很重要了。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> source <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'/path/to/source'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>encoding<span class="token operator">:</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">'/path/to/dest'</span><span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 等价于</span>
<span class="token comment">// pipe是用来传递  上一个流的输出  并将其作为  下一个流的输入的链式方法。</span>
fs<span class="token punctuation">.</span><span class="token function">createReadstream</span><span class="token punctuation">(</span><span class="token string">'/path/to/source'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">'/path/to/dest'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="可读流"><a href="#可读流" class="headerlink" title="可读流"></a>可读流</h3><p>Node. js可读流是对提供数据的来源的一种抽象。所有可读流都实现了stream.Readable类定义的接口。可读流常见的例子包括客户端的HTTP响应、服务器的HTTP请求、fs的读取流、zlib流、crypto流、TCP socket、子进程 stdout 与 stderr、process.stdin。</p>
<h3 id="stream-Readable类事件"><a href="#stream-Readable类事件" class="headerlink" title="stream.Readable类事件"></a>stream.Readable类事件</h3><ol>
<li><p>close 事件<br>close 事件在流被关闭时触发。表明不会再触发其他事件，也不会再发生操作。不是所有可读流都会触发close事件。如果使用 emitClose 选项创建可读流，则它将始终发出close事件。</p>
</li>
<li><p>data 事件<br>data事件是在流将数据块传送给<code>消费者</code>后触发。对于非对象模式的流，数据块可以是字符串或 Buffer。对于对象模式的流，数据块可以是除了 null 的任何 JavaScript 值。<br>当调用 readable.pipe()、readable.resume() 或绑定监听器到 data 事件时，流会转换到流动模式。当调用 readable.read() 且有数据块返回时，也会触发data 事件。<br>如果使用 readable.setEncoding() 为流指定了默认的字符编码，则监听器回调传入的数据为字符串，否则传入的数据为 Buffer。</p>
</li>
<li><p>end 事件<br>end 事件只有在数据被完全消费掉后才会触发。要想触发该事件，可以将流转换到流动模式，或反复调用 stream.read() 直到数据被消费完。</p>
</li>
<li><p>error 事件<br>error事件通常是在当流因底层内部出错而不能产生数据，或推送无效的数据块时触发，监听器回调将传递一个 Error对象。</p>
</li>
<li><p>pause 事件<br>调用 stream.pause() 并且 readsFlowing 不为 false 时，会发出 pause 事件。</p>
</li>
<li><p>readable 事件<br>readable 事件在当流中有数据可供读取时触发。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> readable <span class="token operator">=</span> <span class="token function">getReadableStreamSomehow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

readable<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'readable'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> data<span class="token punctuation">;</span> <span class="token comment">// 有数据可读</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span>data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当到达流数据的尽头时，readable 事件也会触发，但是在 end 事件之前触发。readable 事件表明流有新的动态，要么有新的数据，要么到达流的尽头。对于前者，stream.read() 会返回可用的数据。对于后者，stream.read() 会返回null。</p>
</li>
</ol>
<h3 id="stream-Readable类方法"><a href="#stream-Readable类方法" class="headerlink" title="stream.Readable类方法"></a>stream.Readable类方法</h3><p>1.destroy<br>readable.destroy([error])方法用于销毁流，并触发error事件和close事件。调用后，可读流将释放所有的内部资源，且忽视后续的 push() 调用。实现流时不应该重写这个方法，而是重写 readable._destroy()。</p>
<p>2.isPaused<br>readable.isPaused() 方法用于返回可读流当前的操作状态。主要用于 readable.pipe() 底层的机制，大多数情况下无须直接使用该方法。</p>
<ol start="3">
<li><p>pause 与 resume<br>readable.pause() 方法使流动模式的流<strong>停止触发data事件</strong>，并切换到流动模式。任何可用的数据都会保留在内部缓存中。<br>相对的，readable.resume() 将被暂停的可读流<strong>恢复触发data事件</strong>，并将流切换到流动模式，在readable事件使用不生效。</p>
</li>
<li><p>pipe<br>readable.pipe(destination[, options])方法用于绑定可写流到可读流，将可读流自动切换到流动模式，并将可读流的所有数据推送到绑定的可写流。数据流会被自动管理，所以即使可读流更快，目标可写流也不会超负荷。</p>
</li>
</ol>
<ul>
<li>将可读流的所有数据通过管道推送到write-data.txt文件：<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> readable <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'data.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> writable <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">'write-data.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// readable的所有数据都推送到'write-data.txt'</span>
readable<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>writable<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li>可以在单个可读流上绑定多个可写流<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">readable<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>writable1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>writable2<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li>默认情况下，当来源可读流触发end事件时，目标可写流也会调用stream.end()结束写入。若要禁用这种默认行为，end选项应设为 false，这样目标流就会保持打开。<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">reader<span class="token punctuation">.</span><span class="token function">pipe</span> <span class="token punctuation">(</span>writer<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">end</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
reader<span class="token punctuation">.</span><span class="token function">on</span> <span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    writer<span class="token punctuation">.</span><span class="token function">end</span> <span class="token punctuation">(</span><span class="token string">'结束'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
如果可读流发生错误，目标可写流不会自动关闭，需要手动关闭所有流以避免内存泄漏。process.stderr 和 process.stdout 可写的流在 Node.js 进程退出之前永远不会关闭。</li>
</ul>
<ol start="5">
<li>read</li>
</ol>
<ul>
<li><p>readable.read([size])方法用于从内部缓冲拉取并返回数据。其中，size指定要读取的数据的字节数。如果没有指定size参数，则返回内部缓冲中的所有数据。该方法如果没有可读的数据，则返回null。默认情况下，readable.read()返回的数据是Buffer对象，除非使用readable.setEncoding()指定字符编码或流处于对象模式。如果可读的数据不足size个字节，则返回内部缓冲剩余的数据，如果流已经结束则返回null。</p>
</li>
<li><p>readable.read()应该只对处于暂停模式的可读流调用。在流动模式中，readable.read()会自动调用直到内部缓冲的数据完全耗尽。</p>
</li>
<li><p>如果readable.read()返回一个数据块，则data事件也会触发。</p>
</li>
<li><p>end事件触发后再调用stream.read([size])会返回null，不会抛出错误。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> readable <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'data.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 设置字符编码</span>
readable<span class="token punctuation">.</span><span class="token function">setEncoding</span><span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 读取数据</span>
readable<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'readable'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> chunk<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">!==</span> <span class="token punctuation">(</span>chunk <span class="token operator">=</span> readable<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">接收到 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>chunk<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> 字节的数据</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">接收到的数据是： </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>chunk<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

readable<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'结束'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上述示例中，使用readable.read()处理数据时，while循环是必需的。只有在readable.read()返回null之后，才会发出readable事件;</p>
</li>
</ul>
<p>readable.setEncoding()用于设置字符编码。默认情况下没有设置字符编码，流数据返回的是 Buffer对象。如果设置了字符编码，则流数据返回指定编码的字符串。例如，本例中调用<code>readable.setEncoding(&#39;utf-8&#39;)</code>会将数据解析为UTF-8数据，并返回字符串。如果调用<code>readable.setEncoding(hex)</code>则会将数据编码成十六进制字符串。</p>
<ol start="6">
<li>readable.unpipe([destination])<br>解绑之前使用 stream.pipe() 绑定的可写流。如果没有指定目标可写流，则解绑所有管道，如果指定了目标可写流但它没有建立管道，则不起作用。<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> readable <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'data.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> writable <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">'write-data.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// readable的所有数据都推送到'write-data.txt'</span>
readable<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>writable<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'停止写入数据'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  readable<span class="token punctuation">.</span><span class="token function">unpipe</span><span class="token punctuation">(</span>writable<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'手动关闭文件流'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  writable<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h3 id="两种读取模式"><a href="#两种读取模式" class="headerlink" title="两种读取模式"></a>两种读取模式</h3><p>流动模式或者暂停模式</p>
<p>可读流运作于流动模式(flowing)或暂停模式(paused)两种模式之一。</p>
<ul>
<li>在流动模式中，数据自动从底层系统读取，并通过EventEmitter 接口的事件尽口能快地被提供给应用程序。</li>
<li>在暂停模式中，必须显式调用stream.read()读取数据块。<br>所有可读流都开始于暂停模式，可以通过以下方式切换到流动模式。</li>
<li>添加data事件句柄。</li>
<li>调用stream.resume()。·调用stream.pipe()。<br>可读流可以通过以下方式切换回暂停模式。</li>
<li>如果没有管道目标，则调用stream.pause()。</li>
<li>如果有管道目标，则移除所有管道目标。调用stream.unpipe()可以移除多个管道目标。</li>
</ul>
<p>只有提供了消费或忽略数据的机制后，可读流才会产生数据。如果消费的机制被禁用或移除，则可读流会停止产生数据。</p>
<p>为了向后兼容，移除data事件句柄不会自动地暂停流。如果有管道目标，一旦目标变为drain 状态并请求接收数据时，则调用 stream.pause() 也不能保证流会保持暂停模式。</p>
<p>如果可读流切换到流动模式，且没有可用的“消费者”来处理数据，则数据将会丢失。例如，当调用readable.resume() 时，没有监听data事件或data事件句柄已移除。</p>
<p>添加readable事件句柄会使流自动停止流动，并通过 readable.read() 消费数据。如果 readable 事件句柄被移除，且存在data事件句柄，则流会再次开始流动。</p>
<h3 id="可写流"><a href="#可写流" class="headerlink" title="可写流"></a>可写流</h3><p>可写流是对数据要被写入的目的地的一种抽象。所有可写流都实现了stream.Writable类定义的接口。可写流常见的例子包括客户端的HTTP请求、服务器的HTTP响应、fs的写入流、zlib流、crypto流、TCP socket、子进程stdin、process.stdout、process.stderr。上面的一些例子事实上是实现了可写流接口的双工流。</p>
<h4 id="stream-Writable类事件"><a href="#stream-Writable类事件" class="headerlink" title="stream.Writable类事件"></a>stream.Writable类事件</h4><p>stream.Writable类定义了如下事件。</p>
<ol>
<li><p>close事件<br>当流及其任何底层资源（如文件描述符）已关闭时，将发出close事件。该事件表明不会发出更多事件，也不会进一步计算。<br>如果使用emitClose选项创建可写流，它将始终发出close事件。</p>
</li>
<li><p>drain事件<br>如果对stream.write(chunk)的调用返回false，则在适合继续将数据写入流时将发出drain事件。</p>
</li>
<li><p>error事件<br>如果在写入管道数据时发生错误，则会发出error事件。调用时，监听器回调会传递一个Error参数。<br>发出error事件时，流不会关闭。</p>
</li>
<li><p>finish事件<br>调用stream.end()方法后会发出finish事件，并且所有数据都已刷新到底层系统。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> writable <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">'write-data.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  writable<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">写入 #</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>i<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">!\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

writable<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'写入结尾\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
writable<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'finish'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'写入已完成'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>pipe事件<br>在可读流上调用stream.pipe()方法时会发出pipe事件，并将此可写流添加到其目标集。</p>
</li>
<li><p>unpipe事件<br>当在可读流上调用stream.unpipe()时触发。当可读流通过管道流向可写流发生错误时，也会触发unpipe事件。</p>
</li>
</ol>
<h4 id="stream-Writable类方法"><a href="#stream-Writable类方法" class="headerlink" title="stream.Writable类方法"></a>stream.Writable类方法</h4><ol>
<li>cork<br>writable.cork()方法用于强制把所有写入的数据都缓冲到内存中。当调用stream.uncork()或stream.end()时，缓冲的数据才会被输出。</li>
</ol>
<p>当写入大量小块数据到流时，内部缓冲可能失效，从而导致性能下降，writable.cork()主要用于避免这种情况。对于这种情况，实现了writable._writev()的流可以用更优的方式对写入的数据进行缓冲。</p>
<ol start="2">
<li><p>destroy<br>writable.destroy([error])方法用于销毁流。在调用该方法之后，可写流已结束，随后对write()或end()的调用都将导致ERR_STREAM_DESTROYED错误。如果数据在关闭之前应该刷新，则应使用end()方法而不是destroy()方法，或者在销毁流之前等待drain事件。实现者不应该重写此方法，而是实现writable._destroy()。</p>
</li>
<li><p>end<br>调用writable.end([chunk][, encoding][, callback])方法表示不再将数据写入Writable。该方法的参数如下。</p>
</li>
</ol>
<ul>
<li><p><code>chunk&lt;string&gt;|&lt;Buffer&gt;|&lt;Uint8Array&gt;/&lt;any&gt;</code>:要 写入的可选数据。对于不在对象模式下运行的流，块必须是字符串、Buffer 或 Uint8Array。对于对象模式流，块可以是除null 之外的任何JavaScript 值。</p>
</li>
<li><p><code>encoding&lt;string&gt;</code>: 如果设置了编码，则 chunk 是一个字符串。</p>
</li>
<li><p><code>callback&lt;Function&gt;</code>: 流完成时的可选回调。</p>
</li>
</ul>
<p>调用writable.end()方法表示不再将数据写入Writable。可选的块和编码参数允许在关闭流之前立即写入最后一个额外的数据块。如果提供，则附加可选回调函数作为finish事件的监听器。</p>
<p>调用stream.end()后调用stream.write()方法将引发错误。</p>
<ol start="4">
<li><p>setDefaultEncoding<br>writable.setDefaultEncoding(encoding)为可写流设置默认的编码。</p>
</li>
<li><p>uncork<br>writable.uncork()方法用于将调用stream.cork()后缓冲的所有数据输出到目标。当使用writable.cork() 和 writable.uncork() 来管理流的写入缓冲时，建议使用 process.nextTick() 来延迟调用 writable.uncork()。通过这种方式，可以对单个Node.js事件循环中调用的所有 writable.write() 进行批处理。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">stream<span class="token punctuation">.</span><span class="token function">cork</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stream<span class="token punctuation">.</span><span class="token function">write</span> <span class="token punctuation">(</span><span class="token string">'一些'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'数据'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span> stream<span class="token punctuation">.</span><span class="token function">uncork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果一个流上多次调用 writable.cork()，则必须调用同样次数的 writable.uncork() 才能输出缓冲的数据。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">stream<span class="token punctuation">.</span><span class="token function">cork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stream<span class="token punctuation">.</span><span class="token function">write</span> <span class="token punctuation">(</span><span class="token string">'一些'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
stream<span class="token punctuation">.</span><span class="token function">cork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'数据'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    stream<span class="token punctuation">.</span><span class="token function">uncork</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//数据不会被输出,直到第二次调用uncork()</span>
    stream<span class="token punctuation">.</span><span class="token function">uncork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>write<br>writable.write(chunk[, encoding][, callback]) 写入数据到流，并在数据被完全处理之后调用callback。如果发生错误，则callback可能被调用也可能不被调用。为了可靠地检测错误，可以为error事件添加监听器。该方法的参数如下。</p>
</li>
</ol>
<ul>
<li><code>chunk&lt;string&gt;|&lt;Buffer&gt;|&lt;Uint8Array&gt;|&lt;any&gt;</code>: 要写入的数据。对于非对象模式的流，chunk 必须是字符串、Buffer 或 Uint8Array。对于对象模式的流，chunk 可以除null外的是任何 JavaScript 值。</li>
<li><code>encoding&lt;string&gt;</code>: 如果chunk是字符串，则指定字符编码。</li>
<li><code>callback&lt;Function&gt;</code>: 当数据块被输出到目标后的回调函数。</li>
<li><code>writable.write()</code>: 写入数据到流，并在数据被完全处理之后调用callback。如果发生错误，则callback可能被调用也可能不被调用。为了可靠地检测错误，可以为error事件添加监听器。</li>
</ul>
<p>在接收了chunk后，如果内部的缓冲小于创建流时配置的highWaterMark, 则返回true。如果返回false，则应该停止向流写入数据，直到drain事件被触发。</p>
<p>当流还未被排空时，调用write()会缓冲chunk，并返回false。一旦所有当前缓冲的数据块都被排空了(被操作系统接收并传输)，则触发drain事件。建议一旦write()返回false，则不再写入任何数据块，直到drain事件被触发。当流还未被排空时，也是可以调用write()， Node.js 会缓冲所有被写入的数据块，直到达到最大内存占用，这时它会无条件中止，甚至在它中止之前，高内存占用将会导致垃圾回收器的性能变差和RSS变高(即使内存不再需要，通常也不会被释放回系统)。如果远程的另一端没有读取数据，TCP的socket 可能永远也不会排空，所以写入到一一个不会排空的socket可能会导致产生远程可利用的漏洞。</p>
<p>对于Transform，写入数据到一一个不会排空的流尤其成问题，因为Transform流默认会被暂停，直到它们被pipe或者添加了 data 或readable 事件句柄。</p>
<p>如果要被写入的数据可以根据需要生成或取得，建议将逻辑封装为一一个可读流并且使用stream.pipe()。 如果要优先调用 write()，则可以使用 drain 事件来防止背压与避免内存问题。</p>
<h3 id="双工流与转换流"><a href="#双工流与转换流" class="headerlink" title="双工流与转换流"></a>双工流与转换流</h3><p>双工流（Duplex）是同时实现了Readable和 Writable接口的流。双工括TCP socket、zlib流、crypto流。<br>转换流（Transform）是一种双工流，但它的输出与输入是相关联的。与双工流一样，转换流也同时实现了 Readable 和 Writable 接口。转换流的例子包括 zlib流和 crypto 流。</p>
<h3 id="实现双工流"><a href="#实现双工流" class="headerlink" title="实现双工流"></a>实现双工流</h3><p>双工流同时实现了可读流和可写流，如TCP socket连接。因为JavaScript不支持多重继承，所以使用stream.Duplex类来实现双工流（而不是使用stream.Readable类和stream.Writable类)。<br>stream.Duplex类的原型继承自stream.Readable和寄生自stream.Writable，但是instanceof对这两个基础类都可用，因为重写了 stream.Writable 的Symbol.hasInstance。<br>自定义的双工流必须调用<code>new stream.Duplex([options])</code>构造函数并实现 readable._read() 和 writable._write() 方法。以下是示例。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">&#123;</span> Duplex <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'stream'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">MyDuplex</span> <span class="token keyword">extends</span> <span class="token class-name">Duplex</span> <span class="token punctuation">&#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="双工流的例子"><a href="#双工流的例子" class="headerlink" title="双工流的例子"></a>双工流的例子</h3><p>封装了一个可读可写的底层资源对象</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">&#123;</span> Duplex <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'stream'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> kSource <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'source'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">MyDuplex</span> <span class="token keyword">extends</span> <span class="token class-name">Duplex</span> <span class="token punctuation">&#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">[</span>kSource<span class="token punctuation">]</span> <span class="token operator">=</span> source<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">_write</span><span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 底层资源只处理字符串。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">isBuffer</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      chunk <span class="token operator">=</span> chunk<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">this</span><span class="token punctuation">[</span>kSource<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">writeSomeData</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">_read</span><span class="token punctuation">(</span><span class="token parameter">size</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">[</span>kSource<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">fetchSomeData</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> encoding</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> encoding<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="net模块"><a href="#net模块" class="headerlink" title="net模块"></a>net模块</h2><p>在nodejs中，net模块用于创建基于流的TCP或IPC的服务器与客户端。net主要包含两个部分：</p>
<ul>
<li>net.Server: TCP Server，内部通过socket来实现与客户端的通信。</li>
<li>net.Socket: TCP&#x2F;本地socket的Node版实现，它实现了全双工的stream接口，可以用来构建TCP客户端。</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'net'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="创建TCP服务器"><a href="#创建TCP服务器" class="headerlink" title="创建TCP服务器"></a>创建TCP服务器</h3><ol>
<li>net.Server类创建TCP或IPC服务器</li>
<li>net.Server支持如下事件：</li>
</ol>
<ul>
<li>listening事件: 当服务被绑定后调用server.listen()方法后触发。</li>
<li>connection事件: 当一个新的connection建立的时候触发，回调参数为socket连接对象。</li>
<li>close事件：当TCP服务器关闭的时候触发，回调函数没有参数。</li>
<li>error事件: 当TCP服务器出现错误的时候触发，回调函数的参数为err对象。例如，监听了已经被占用的端口号。</li>
</ul>
<h3 id="创建TCP服务器示例"><a href="#创建TCP服务器示例" class="headerlink" title="创建TCP服务器示例"></a>创建TCP服务器示例</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'net'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    socket<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'goodbye\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 处理错误</span>
    <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'服务器接收到close事件'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">// socket对象，对象可以与客户端进行通信</span>
server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'服务器接收到connection事件'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'listening'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'服务器接收到listening事件'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">// 随机获取未绑定的端口</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'服务器启动，占用端口：'</span><span class="token punctuation">,</span> server<span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当创建了一个TCP服务器后，可以通过 server.address()方法来查看这个TCP服务器监听的地址，并返回一个JSON对象。这个对象的属性有:</p>
<ul>
<li>port: TCP服务器监听的端口号。</li>
<li>family: 说明TCP服务器监听的地址是IPv6还是IPv4。</li>
<li>address: TCP服务器监听的地址。<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/**
 * 查看服务器监听的地址
 */</span>

<span class="token comment">/* 引入net模块 */</span>
<span class="token keyword">var</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"net"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* 创建TCP服务器 */</span>
<span class="token keyword">var</span> server <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'someone connects'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">/* 获取地址信息 */</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token comment">/* 获取地址信息，得到的是一个json &#123; address: '::', family: 'IPv6', port: 8000 &#125; */</span>
   <span class="token keyword">var</span> address <span class="token operator">=</span> server<span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">/* TCP服务器监听的端口号 */</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"the port of server is"</span> <span class="token operator">+</span> address<span class="token punctuation">.</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">/* TCP服务器监听的地址 */</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"the address of server is"</span> <span class="token operator">+</span> address<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">/* 说明TCP服务器监听的地址是 IPv6 还是 IPv4 */</span>
   console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"the family of server is"</span> <span class="token operator">+</span> address<span class="token punctuation">.</span>family<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
创建一个TCP服务器后，可以通过server.getConnections()方法获取连接这个TCP服务器的客户端数量。除此之外，也可以通过maxConnections属性来设置这个服务器的最大连接数量，当连接数量超过最大值时，服务器将拒绝新的连接，例如:<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/**
 * 连接服务器的客户端数量
 */</span>

<span class="token comment">/* 引入net模块 */</span>
<span class="token keyword">var</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"net"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* 创建TCP服务器 */</span>
<span class="token keyword">var</span> server <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'someone connects'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 设置最大连接数量 */</span>
    server<span class="token punctuation">.</span>maxConnections <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span><span class="token function">getConnections</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> count</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"the count of client is "</span> <span class="token operator">+</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">/* 获取监听端口 */</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Creat server on http://127.0.0.1:8000/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
服务器和客户端之间的通信：socket对象可以用来获取客户端发出的流数据，每次接收到数据的时候触发data事件，通过监听这个事件就可以在回调函数中获取客户端发送的数据。<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/**
 * 连接服务器的客户端数量
 */</span>

<span class="token comment">/* 引入net模块 */</span>
<span class="token keyword">var</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"net"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* 创建TCP服务器 */</span>
<span class="token keyword">var</span> server <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">/* 获取地址信息 */</span>
    <span class="token keyword">var</span> address <span class="token operator">=</span> server<span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> message <span class="token operator">=</span> <span class="token string">"the server address is"</span><span class="token operator">+</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 发送数据 */</span>
    socket<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">var</span> writeSize <span class="token operator">=</span> socket<span class="token punctuation">.</span>bytesWritten<span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>message <span class="token operator">+</span> <span class="token string">"has send"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"the size of message is"</span><span class="token operator">+</span>writeSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

    <span class="token comment">/* 监听data事件，每次接收到数据的时候触发data事件 */</span> 
    socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> readSize <span class="token operator">=</span> socket<span class="token punctuation">.</span>bytesRead<span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"the size of data is"</span><span class="token operator">+</span>readSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">/* 获取地址信息 */</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Creat server on http://127.0.0.1:8000/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h3 id="server-listen监听链接"><a href="#server-listen监听链接" class="headerlink" title="server.listen监听链接"></a>server.listen监听链接</h3><p>listen()方法是异步的。当服务器开始监听时，会触发listening事件。最后一个参数callback将被添加为listening事件的监听器。</p>
<p>当且仅当在第一次调用server.listen()或调用server.close()期间出现错误时，才能再次调用server.listen()方法。</p>
<p>监听时最常见的错误之一是EADDRINUSE, 这说明该地址正被另一个服务器所使用。处理此问题的一种方法是在一段时间后重试。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token string">'EADDRINUSE'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'地址正被使用，重试中。。。'</span><span class="token punctuation">)</span>

        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>
            server<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token constant">PORT</span><span class="token punctuation">,</span> <span class="token constant">HOST</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>server.listen(options[, callback])方法中的options参数支持如下属性</p>
<ul>
<li><code>port&lt;number&gt;</code>: 端口号。</li>
<li><code>host&lt;string&gt;</code>: 主机。</li>
<li><code>path&lt;string&gt;</code>: 如果指定了port，将被忽略。</li>
<li><code>backlog&lt;number&gt;</code>。如果exclusive为 false，则集群将使用相同的底层句柄，从而允许共享连接处理。当exclusive为 true时，不共享句柄，并且尝试端口共享会导致错误。监听专用端口的示例如下。</li>
<li><code>exclusive&lt;boolean&gt;</code>: 默认值是false。</li>
<li><code>readableAll&lt;boolean&gt;</code>: 对于IPC服务器，使管道对所有用户都可读，默认值是false。</li>
<li><code>writableAll&lt;boolean&gt;</code>: 对于IPC服务器，管道可以为所有用户写入，默认值是false。</li>
</ul>
<h3 id="创建Socket对象发送和接受数据"><a href="#创建Socket对象发送和接受数据" class="headerlink" title="创建Socket对象发送和接受数据"></a>创建Socket对象发送和接受数据</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'net'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 处理错误</span>
    <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'服务器接收到close事件'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'服务器接收到connection事件'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    socket<span class="token punctuation">.</span><span class="token function">setEncoding</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    socket<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'welcome!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发送数据</span>

    socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'服务器接收到的数据为：'</span> <span class="token operator">+</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 如果收到c字符，就终止连接</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">==</span> <span class="token string">'c'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            socket<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'bye!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            socket<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭socket</span>
            <span class="token comment">// 如果收到k字符，就关闭服务器</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">==</span> <span class="token string">'k'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            socket<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'bye!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            socket<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭socket</span>
            server<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 关闭服务器</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            socket<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'listening'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'服务器接收到listening事件'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">// 绑定到端口</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'服务器启动，端口：8888'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在上述示例中，socket.write() 方法用于将数据写入 Socket发送; socket通过data事件，可以监听来自客户端写入的数据(接收)。在上述示例中，会将接收到的数据，再通过 socket.write() 方法发送回客户端。</p>
<p>关闭TCP服务器：TCP服务器通过 socket.end() 终止客户端的连接，也可以通过 server.close() 方法来将整个TCP服务器关闭。当TCP服务器关闭时，会监听到close事件。</p>
<h3 id="构建TCP客户端"><a href="#构建TCP客户端" class="headerlink" title="构建TCP客户端"></a>构建TCP客户端</h3><p>可以用net.Socket构建TCP客户端，实现TCP客户端和TCP服务器的通信。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/**
 * 构建TCP客户端
 */</span>

<span class="token comment">/* 引入net模块 */</span>
<span class="token keyword">var</span> net <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"net"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* 创建TCP客户端 */</span>
<span class="token keyword">var</span> client <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">Socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* 设置连接的服务器 创建完socket对象后，使用socket对象的connect方法就可以连接一个TCP服务器。*/</span>
client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">,</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"connect the server"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* 向服务器发送数据 */</span>
  client<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"message from client"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">/* 监听服务器传来的data数据 */</span>
client<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"the data of server is "</span> <span class="token operator">+</span> data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">/* 监听end事件 */</span>
client<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"end"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"data end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>net.Socket连接相关的API有:</li>
</ol>
<ul>
<li>socket.connect(): 有3种不同的参数，用于不同的场景。</li>
<li>socket.setTimeout(): 用来进行连接超时设置。</li>
<li>socket.setKeepAlive(): 用来设置长连接。</li>
<li>socket.destroy( )、socket.destroyed: 当错误发生时，用来销毁socket，确保这个socket上不会再有其他的IO操作。</li>
</ul>
<ol start="2">
<li>net.Socket涉及的事件:</li>
</ol>
<ul>
<li>data: 当收到另一侧传来的数据时触发。</li>
<li>connect: 当连接建立时触发。</li>
<li>close: 当连接断开时触发。如果是因为传输错误导致的连接断开，参数就为error。</li>
<li>end: 当连接另一侧发送了FIN包的时候触发。默认情况下(allowHalfOpen &#x3D;&#x3D; false)，socket会完成自我销毁操作。但也可以把allowHalfOpen设置为true，这样就可以继续往socket里写数据。当然，最后需要手动调用socket.end()。</li>
<li>error: 当有错误发生时就会触发，参数为error。</li>
<li>timeout: 示用户socket已经超时，需要手动关闭连接。</li>
<li>drain: 当写缓存空了的时候触发。</li>
<li>lookup: 当域名解析完成时触发。</li>
</ul>
<h2 id="http"><a href="#http" class="headerlink" title="http"></a>http</h2><p>http.Server类是继承自net.Server，有很多net.Server的方法和事件。</p>
<p>net、http、dgram模块分别用来实现TCP、HTTP、UDP的通信。http为应用层模块，主要按照特定协议编解码数据; net为传输层模块，主要负责传输编码后的应用层数据; https是一个综合模块（涵盖了http&#x2F;tIs&#x2F;crypto等)，主要用于确保数据安全性。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> hostname <span class="token operator">=</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">8080</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/plain'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'Hello World\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 用于完成发送请求</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> hostname<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">服务器运行在 http://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>hostname<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>port<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="http-Server事件"><a href="#http-Server事件" class="headerlink" title="http.Server事件"></a>http.Server事件</h3><ol>
<li>close事件：服务器关闭时触发close事件</li>
<li>connection事件：建立新的TCP流是会发出connection事件</li>
<li>request事件：每次有请求时都会发出request事件。注意，在HTTP Keep-Alive连接的情况下每个连接可能会有多个请求。</li>
</ol>
<h3 id="http-requset发送请求"><a href="#http-requset发送请求" class="headerlink" title="http.requset发送请求"></a>http.requset发送请求</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span> <span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> req <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">8080</span><span class="token punctuation">,</span>
    <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'POST'</span> <span class="token comment">// 默认是GET，POST、PUT、DELETE</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    res<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span> <span class="token punctuation">(</span><span class="token string">'请求完成!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="http请求对象和响应对象"><a href="#http请求对象和响应对象" class="headerlink" title="http请求对象和响应对象"></a>http请求对象和响应对象</h3><p>HTTP请求对象和响应对象在 Node.js中是被定义在 http.ClientRequest和http.ServerResponse类中的。</p>
<h4 id="http-ClientRequest"><a href="#http-ClientRequest" class="headerlink" title="http.ClientRequest"></a>http.ClientRequest</h4><p>http.ClientRequest对象由http.request()内部创建并返回。它表示正在进行的请求，且其请求头已进入队列。请求头仍然可以使用</p>
<ul>
<li>getHeader(name) 返回请求头的值</li>
<li>removeHeader(name) 改变。</li>
</ul>
<p>实际的请求头将与第一个数据块一起发送，或者当调用request.end()时发送。</p>
<p>要获得响应，则为请求对象添加response事件监听器。当接收到响应头时，将会从请求对象触发response事件。response事件执行时有一个参数，该参数是http.IncomingMessage的实例。</p>
<p>在response事件期间，可以添加监听器到响应对象，如监听data事件。</p>
<p>如果没有添加response事件处理函数，则响应将被完全丢弃。如果添加了response事件处理函数，则必须消费完响应对象中的数据，每当有readable事件时，会调用response.read()，或添加 data事件处理函数，或调用.resume()方法。在消费完数据之前，不会触发end事件。此外，在读取数据之前，它将占用内存，最终可能导致进程内存不足的错误。</p>
<h4 id="http-ServerResponse类"><a href="#http-ServerResponse类" class="headerlink" title="http.ServerResponse类"></a>http.ServerResponse类</h4><p>http.ServerResponse对象由HTTP服务器在内部创建，而不是由用户创建。它作为第二个参数传给request事件。ServerResponse继承自Stream。</p>
<ul>
<li>close事件：表示底层链接已经终止</li>
<li>finish事件：在响应发送后触发。</li>
<li>response.end()方法<br><code>response.end([data][, encoding][, callback])</code>方法用于向服务器发出信号，表示已发送所有响应标头和正文，该服务器应该考虑此消息已完成。必须在每个响应上调用response.end() 方法。</li>
</ul>
<p>如果指定了data，则它实际上类似于先调用response.write(data, encoding)方法，接着调用response.end()方法。如果指定了callback，则在响应流完成时将调用它。</p>
<ul>
<li>response.setHeader(name, value)：设置响应头。</li>
<li>response.getHeaderNames()：返回已经设置的响应头属性数组。</li>
<li>response.getHeaders()：返回已经设置的响应头，以key-vale表示。</li>
</ul>
<h4 id="REST-ful风格"><a href="#REST-ful风格" class="headerlink" title="REST ful风格"></a>REST ful风格</h4><ul>
<li>若要在服务器上创建资源，应该使用POST方法。</li>
<li>若要检索某个资源，应该使用GET方法。</li>
<li>若要更新或添加资源，应该使用PUT方法。</li>
<li>若要删除某个资源，应该使用DELETE方法。</li>
</ul>
<h1 id="npm"><a href="#npm" class="headerlink" title="npm"></a>npm</h1><p>npm全称node package manager即node包管理器。</p>
<p>查看当前项目的所有NPM脚本命令，可以使用不带任何参数的npm run命令:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> run<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>npm 脚本的原理相对简单，每当执行npm run时，会自动新建一个Shell，在该Shell 中执行指定的脚本命令。</p>
<p>因此，只要是Shell (一般是Bash)可以运行的命令，就可以写在 NPM脚本里面。需要注意的是，npm run新建的 Shell 会将当前目录的node_modules.bin子目录加入PATH变量，命令执行结束后，再将PATH 变量恢复。也就是说，当前目录的node_modules&#x2F;.bin子目录里面的所有脚本都可以直接用脚本名调用，而不必加上路径。例如，当前项目的依赖里面有Mocha，只需要直接写mocha test即可:</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"script"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"test"</span> <span class="token operator">:</span> <span class="token string">"mocha test"</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// 而不需要写成:</span>
<span class="token property">"script"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"test"</span> <span class="token operator">:</span><span class="token string">"./node_modules/.bin/mocha test"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>由于NPM脚本的唯一要求是可以在Shell 中执行，因此它不一定是Node脚本，任何可执行文件都可以写在script中。</p>
<p>安装的局部开发依赖如果有命令，会在node_modules&#x2F;.bin目录创建软连接，package.json是可以读取到依赖下.bin目录下的命令，可以在package.json直接使用该命令。</p>
<h2 id="package-json"><a href="#package-json" class="headerlink" title="package.json"></a>package.json</h2><p>package.json可以手动编写，也可以使用npm init命令自动生成，它描述了项目使用到的模块，项目名称（必填）、版本号（必填）、许可、关键词。</p>
<ul>
<li>Name: 包名。</li>
<li>Version: 包的版本号，语义版本号分为X.Y.Z三位，分别代表主版本号、次版本号和补丁版本号。</li>
<li>Description: 包的描述。</li>
<li>Homepage: 包的官网地址。</li>
<li>Author: 包的作者姓名。</li>
<li>Contributors: 包的其他贡献者姓名。</li>
<li>Dependencies: 依赖包列表，指定了项目运行所依赖的模块。如果依赖包没有安装，npm就会自动将依赖包安装在node_module目录下。</li>
<li>devDependencies: 指定项目开发所需要的模块。</li>
<li>repository: 包代码存放的地方的类型，可以是Git或Svn，Git可在GitHub 上。</li>
<li>main: main字段指定了程序的主入口文件, require(‘moduleName’)就会加载这个文件。这个字段的默认值是模块根目录下面的index.js。</li>
<li>keywords: 关键字。</li>
<li>scripts: 指定了运行脚本命令的npm命令行缩写，比如 start 指定了运行npm run start时所要执行的命令。</li>
<li>bin: 用来指定各个内部命令对应的可执行文件的位置。</li>
<li>config: 用于添加命令行的环境变量。</li>
</ul>
<h2 id="npm命令"><a href="#npm命令" class="headerlink" title="npm命令"></a>npm命令</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 更新模块：</span>
<span class="token function">npm</span> update module

<span class="token comment"># 查看安装的模块：</span>
<span class="token function">npm</span> list -g <span class="token comment"># 查看全局安装的模块</span>
<span class="token function">npm</span> list <span class="token comment"># 查看本地安装的模块</span>

<span class="token comment"># 查看某个模块的信息</span>
<span class="token function">npm</span> list koa

<span class="token comment"># 查看命令详细帮助</span>
<span class="token function">npm</span> <span class="token builtin class-name">help</span>

<span class="token comment"># 查看包的安装路径</span>
<span class="token function">npm</span> root <span class="token punctuation">[</span>-g<span class="token punctuation">]</span>

<span class="token comment"># 清除npm本地缓存</span>
<span class="token function">npm</span> cache clean<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="WebSocket"><a href="#WebSocket" class="headerlink" title="WebSocket"></a>WebSocket</h1><p>WebSocket 提供了一个真正的全双工连接，它可用于客户机和服务器之间的双向通信，客户端和服务器可以随意向对方发送数据。</p>
<p>该方案的优点是属于HTML5标准，已经被大多数浏览器支持，而且是真正的全双工，性能比较好。其缺点是实现起来相对比较复杂，需要对ws协议专门处理。</p>
<h2 id="使用ws创建WebSocket服务器"><a href="#使用ws创建WebSocket服务器" class="headerlink" title="使用ws创建WebSocket服务器"></a>使用ws创建WebSocket服务器</h2><p>Node.js原生API并未提供 WebSocket的支持，因此，需要安装第三方包才能使用WebSocket 功能。</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// npm i ws</span>
<span class="token keyword">const</span> WebSocket <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ws'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket<span class="token punctuation">.</span>Server</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> 
    <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">8080</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>WebSocket.Server(options[, callback]）方法中的options对象支持如下参数。</p>
<ul>
<li><code>host&lt;String&gt;</code>: 绑定服务器的主机名。</li>
<li><code>port&lt;Number&gt;</code>: 绑定服务器的端口。</li>
<li><code>backlog&lt;Number&gt;</code>: 挂起连接队列的最大长度。</li>
<li><code>server</code>: 预先创建的Node.js HTTP&#x2F;S服务器。</li>
<li><code>verifyClient&lt;Function&gt;</code>: 可用于验证传入连接的函数。</li>
<li><code>handleProtocols&lt;Function&gt;</code>: 可用于处理WebSocket子协议的函数。</li>
<li><code>path&lt;String&gt;</code>: 仅接受与此路径匹配的连接。</li>
<li><code>noServer&lt;Boolean&gt;</code>: 不启用服务器模式。</li>
<li><code>clientTracking&lt;Boolean&gt;</code>: 指定是否跟踪客户端。</li>
<li><code>perMessageDeflate</code>: 启用&#x2F;禁用消息压缩。</li>
<li><code>maxPayload&lt;Number&gt;</code>: 允许的最大消息大小(以字节为单位)。</li>
</ul>
<h2 id="ws事件"><a href="#ws事件" class="headerlink" title="ws事件"></a>ws事件</h2><ul>
<li>ws监听事件：connection。只要有WebSocket连接到该服务器，就能触发connection事件。</li>
<li>如果想获知所有的已连接的客户端信息，则可以使用server.clients数据集。该数据集存储了所有已连接的客户端。</li>
</ul>
<h2 id="发送和接收数据"><a href="#发送和接收数据" class="headerlink" title="发送和接收数据"></a>发送和接收数据</h2><p>ws通过websocket.send()方法发送数据，通过监听message事件来接受数据。</p>
<h3 id="发送数据"><a href="#发送数据" class="headerlink" title="发送数据"></a>发送数据</h3><p><code>websocket.send(data[, options][, callback])</code>方法可以用来发送数据。data参数就是用来发送的数据。options对象的属性可以有以下几种。</p>
<ul>
<li>compress: 用于指定数据是否需要压缩。默认是true。</li>
<li>binary: 用于指定数据是否通过二进制传送。默认是自动检测。</li>
<li>mask: 用于指定是否应遮罩数据。当WebSocket不是服务器客户端时，默认认为true。</li>
<li>fin: 用于指定数据是否为消息的最后一个片段，默认为true。</li>
</ul>
<h4 id="发送ping和pong"><a href="#发送ping和pong" class="headerlink" title="发送ping和pong"></a>发送ping和pong</h4><p>在消息通信中, <code>ping-pong</code>是一种验证客户端和服务器是否正常连接的简单机制。当客户端给服务器发送<code>ping</code>消息时，如果服务器能够正常响应<code>pong</code>消息，则说明客户端和服务器之间的通信是正常的。反之亦然，如果服务器想验证客户端的连接是否正常，也可以给客户端发送<code>ping</code>消息。<br>ws提供了一种快捷的方式来发送<code>ping</code>消息和<code>pong</code>消息。</p>
<ul>
<li>websocket.ping([data[, mask]][, callback])</li>
<li>websocket.pong([data[, mask]][, callback])</li>
</ul>
<h4 id="接收数据"><a href="#接收数据" class="headerlink" title="接收数据"></a>接收数据</h4><p>ws通过message事件来接收数据</p>
<h3 id="准备状态"><a href="#准备状态" class="headerlink" title="准备状态"></a>准备状态</h3><p>ws 中的 WebSocket类具有以下4种准备状态。</p>
<ul>
<li>CONNECTING: 值为0，表示连接还没有打开。</li>
<li>OPEN: 值为1，表示连接已打开，可以通信了。</li>
<li>CLOSING: 值为2，表示连接正在关闭。</li>
<li>CLOSED: 值为2，表示连接已关闭。<br>需要注意的是，当通过 WebSocket对象进行通信时，状态必须是OPEN。</li>
</ul>
<h3 id="关闭WebSocket服务器"><a href="#关闭WebSocket服务器" class="headerlink" title="关闭WebSocket服务器"></a>关闭WebSocket服务器</h3><p>可以通过server.close()来关闭服务器，并通过close事件监听服务器的关闭。</p>
<h3 id="ws例子"><a href="#ws例子" class="headerlink" title="ws例子"></a>ws例子</h3><ul>
<li>服务端<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> WebSocket <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ws'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> WebSocketServer <span class="token operator">=</span> WebSocket<span class="token punctuation">.</span>Server<span class="token punctuation">;</span>
<span class="token keyword">const</span> wss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocketServer</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">3000</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

wss<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ws</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[SERVER] connection()</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[SERVER] Received: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>message<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">What's your name?</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[SERVER] error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>err<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ws server started at port 3000...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li>客户端（浏览器）<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// client test:</span>

<span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> ws <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">'ws://localhost:3000/ws/chat'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[CLIENT] open()</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Hello!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

ws<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[CLIENT] Received: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>message<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  count<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">></span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Goodbye!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ws<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Hello, I'm Mr No.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>count<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
WebSocket 协议本身不要求同源策略（Same-Origin Policy)，也就是某个地址为 <code>http://a.com</code>的网页可以通过 WebSocket连接到<code>ws://b.com</code>。但是，浏览器会发送 Origin 的 HTTP 头给服务器，服务器可以根据 Origin 拒绝这个 WebSocket 请求。所以，是否要求同源要看服务器端如何检查。</li>
</ul>
<h1 id="MySQL基本操作"><a href="#MySQL基本操作" class="headerlink" title="MySQL基本操作"></a>MySQL基本操作</h1><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 显示已有的数据库</span>
show databases<span class="token punctuation">;</span>

<span class="token comment"># 创建数据库</span>
CREATE DATABASES data_name<span class="token punctuation">;</span> <span class="token comment"># nodejs_book</span>

<span class="token comment"># 使用数据库</span>
use data_name<span class="token punctuation">;</span>

<span class="token comment"># 建表</span>
mysql<span class="token operator">></span> CREATE TABLE t_user <span class="token punctuation">(</span> user_id BIGINT NOT NULL, username VARCHAR<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">))</span><span class="token punctuation">;</span>

<span class="token comment"># 查看表</span>
show TABLES<span class="token punctuation">;</span>

<span class="token comment"># 显示表的结构</span>
mysql<span class="token operator">></span> DESCRIBE t_user<span class="token punctuation">;</span>

<span class="token comment"># 往表中加入记录</span>
mysql<span class="token operator">></span> insert into t_user values<span class="token punctuation">(</span><span class="token number">1</span>, <span class="token string">'yolo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="使用node-js操作mysql"><a href="#使用node-js操作mysql" class="headerlink" title="使用node.js操作mysql"></a>使用node.js操作mysql</h2><p>使用mysql或者mysql2模块</p>
<h2 id="实现简单的查询"><a href="#实现简单的查询" class="headerlink" title="实现简单的查询"></a>实现简单的查询</h2><ul>
<li>mysql.createConnection()用于创建一个连接;</li>
<li>connection.connect()方法用于建立连接; </li>
<li>connection.query()方法用于执行查询，第一个参数就是待执行的SQL语句; </li>
<li>connection.end()用于关闭连接。</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> mysql <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 连接信息</span>
<span class="token keyword">const</span> connection <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">user</span><span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">'123456'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">database</span><span class="token operator">:</span> <span class="token string">'nodejs_book'</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 建立连接</span>
<span class="token comment">/// connection.connect();</span>

connection<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'error connecting: '</span> <span class="token operator">+</span> err<span class="token punctuation">.</span>stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'connected as id '</span> <span class="token operator">+</span> connection<span class="token punctuation">.</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 执行查询</span>
connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT * FROM t_user'</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 打印查询结果</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'SELECT result is: '</span><span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// 关闭连接</span>
<span class="token comment">///connection.end();</span>
<span class="token comment">///connection.destroy();</span>

connection<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'error end: '</span> <span class="token operator">+</span> err<span class="token punctuation">.</span>stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end connection'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="mysql模块连接选项"><a href="#mysql模块连接选项" class="headerlink" title="mysql模块连接选项"></a>mysql模块连接选项</h3><table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">host</td>
<td align="center">主机地址,默认是localhost</td>
</tr>
<tr>
<td align="center">user</td>
<td align="center">用户名</td>
</tr>
<tr>
<td align="center">password</td>
<td align="center">密码</td>
</tr>
<tr>
<td align="center">port</td>
<td align="center">端口号，默认是3306</td>
</tr>
<tr>
<td align="center">database</td>
<td align="center">数据库名</td>
</tr>
<tr>
<td align="center">charset</td>
<td align="center">连接字符集（默认:<code>&#39;UTF8_GENERAL_CI&#39;</code>，注意字符集的字母都要大写)</td>
</tr>
<tr>
<td align="center">localA ddress</td>
<td align="center">此IP用于TCP连接（可选)</td>
</tr>
<tr>
<td align="center">socketPath</td>
<td align="center">连接到unix域路径，当使用host和port时会被忽略</td>
</tr>
<tr>
<td align="center">timezone</td>
<td align="center">时区，默认是<code>&#39;local&#39;</code></td>
</tr>
<tr>
<td align="center">connectTimeout</td>
<td align="center">连接超时，单位为毫秒。默认为不限制</td>
</tr>
<tr>
<td align="center">stringifyObjects</td>
<td align="center">是否序列化对象</td>
</tr>
<tr>
<td align="center">typeCast</td>
<td align="center">是否将列值转换为本地JavaScript类型值。默认为true</td>
</tr>
<tr>
<td align="center">queryFormat</td>
<td align="center">自定义query语句格式化方法</td>
</tr>
<tr>
<td align="center">supportBigNumbers</td>
<td align="center">数据库支持bigint或decimal类型列时，需要设此option为true。默认为false</td>
</tr>
<tr>
<td align="center">bigNumberStrings</td>
<td align="center">supportBigNumbers和bigNumberStrings启用，强制bigint或decimal列以JavaScript字符串类型返回。默认为false</td>
</tr>
<tr>
<td align="center">dateStrings</td>
<td align="center">强制timestamp、datetime、data类型以字符串类型返回，而不是JavaScript Date类型。默认为false</td>
</tr>
<tr>
<td align="center">debug</td>
<td align="center">开启调试。默认为false</td>
</tr>
<tr>
<td align="center">multipleStatements</td>
<td align="center">是否允许一个query中有多个MySQL语句。默认为false</td>
</tr>
<tr>
<td align="center">flags</td>
<td align="center">用于修改连接标志</td>
</tr>
<tr>
<td align="center">ssl</td>
<td align="center">使用ssl参数或一个包含ssl配置文件名称的字符串</td>
</tr>
</tbody></table>
<h3 id="mysql模块CRUD"><a href="#mysql模块CRUD" class="headerlink" title="mysql模块CRUD"></a>mysql模块CRUD</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 执行查询</span>
connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT * FROM t_user'</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 打印查询结果</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'SELECT result is: '</span><span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 插入数据 </span>
<span class="token comment">// 其中，在SQL语句中，通过“?”占位符的方式将参数对象data进行传入。</span>
<span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">user_id</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token literal-property property">username</span><span class="token operator">:</span> <span class="token string">'waylau'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'INSERT INTO t_user SET ?'</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 打印查询结果</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'INSERT result is: '</span><span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 更新数据</span>
<span class="token comment">// 通过“?"占位符的方式将参数对象进行传入。所不同的是，参数对象是一个数组。</span>
connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'UPDATE t_user SET username = ? WHERE user_id = ?'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'Way Lau'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 打印查询结果</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'UPDATE result is: '</span><span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 执行查询</span>
<span class="token comment">// 同样也是通过“?占位符的方式将参数对象进行传入。所不同的是，参数对象是一个数值（用户ID)。</span>
connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT * FROM t_user'</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 打印查询结果</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'SELECT result is: '</span><span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="mysql连接池"><a href="#mysql连接池" class="headerlink" title="mysql连接池"></a>mysql连接池</h2><p>建议将连接池的pool.getConnection封装一下，实现复用</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">8080</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'body-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//用于req.</span>
<span class="token keyword">const</span> <span class="token constant">URL</span> <span class="token operator">=</span> <span class="token string">'/api/users'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> mysql <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 连接信息.</span>
<span class="token comment">// 使用连接池</span>
<span class="token keyword">const</span> pool <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createPool</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    <span class="token literal-property property">connectionLimit</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token comment">// 连接数限制</span>
    <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">user</span><span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">password</span><span class="token operator">:</span> <span class="token string">'123456'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">database</span><span class="token operator">:</span> <span class="token string">'nodejs_book'</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 获取所有用户列表API</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">URL</span> <span class="token operator">+</span> <span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 获取连接</span>
    pool<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> connection</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 从请求参数中获取用户ID</span>
        <span class="token keyword">let</span> name <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>name<span class="token punctuation">;</span>

        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'User name is: '</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 执行查询</span>
            connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT * FROM t_user'</span><span class="token punctuation">,</span>
                <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// 错误处理</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>

                    <span class="token comment">// 打印执行结果</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'The result is: '</span><span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// 释放连接</span>
                    connection<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// 转为JSON返回</span>
                    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 执行查询</span>
            connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT * FROM t_user where username = ?'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span>
                <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// 错误处理</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
                    <span class="token punctuation">&#125;</span>

                    <span class="token comment">// 打印查询结果</span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'The result is: '</span><span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// 释放连接</span>
                    connection<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment">// 转为JSON返回</span>
                    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// 获取指定ID的用户API</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">URL</span> <span class="token operator">+</span> <span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>


    <span class="token comment">// 获取连接</span>
    pool<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> connection</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 从请求参数中获取用户ID</span>
        <span class="token keyword">let</span> id <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">;</span>

        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'User id is: '</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 执行查询</span>
        connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT * FROM t_user where user_id = ?'</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span>
            <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 错误处理</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>

                <span class="token comment">// 打印执行结果</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'The result is: '</span><span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 释放连接</span>
                connection<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 取第一个，转为JSON返回</span>
                res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// 创建用户信息API</span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token constant">URL</span> <span class="token operator">+</span> <span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 获取连接</span>
    pool<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> connection</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 从请求参数中获取用户信息</span>
        <span class="token keyword">let</span> username <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>username<span class="token punctuation">;</span>

        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'User is: '</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 执行查询</span>
        connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'INSERT INTO t_user (username) VALUES (?)'</span><span class="token punctuation">,</span> username<span class="token punctuation">,</span>
            <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 错误处理</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>

                <span class="token comment">// 打印执行结果</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'The result is: '</span><span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 释放连接</span>
                connection<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 转为JSON返回</span>
                res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 更新用户信息API</span>
app<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token constant">URL</span> <span class="token operator">+</span> <span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 获取连接</span>
    pool<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> connection</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 从请求参数中获取用户信息</span>
        <span class="token keyword">let</span> user_id <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>user_id<span class="token punctuation">;</span>
        <span class="token keyword">let</span> username <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>username<span class="token punctuation">;</span>

        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'User id is: '</span><span class="token punctuation">,</span> user_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'User name is: '</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 执行查询</span>
        connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'UPDATE t_user SET username = ? WHERE user_id = ? '</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>username<span class="token punctuation">,</span> user_id<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 错误处理</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>

                <span class="token comment">// 打印执行结果</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'The result is: '</span><span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 释放连接</span>
                connection<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 转为JSON返回</span>
                res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 删除指定ID的用户API</span>
app<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token constant">URL</span> <span class="token operator">+</span> <span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 获取连接</span>
    pool<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> connection</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 从请求参数中获取用户ID</span>
        <span class="token keyword">let</span> id <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">;</span>

        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'User id is: '</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 执行查询</span>
        connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'DELETE FROM t_user WHERE user_id = ? '</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span>
            <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> results</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 错误处理</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>

                <span class="token comment">// 打印执行结果</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'The result is: '</span><span class="token punctuation">,</span> results<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 释放连接</span>
                connection<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 转为JSON返回</span>
                res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Server listening on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>port<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><p>Redis是一个高性能的key-vale缓存数据库</p>
<p>Redis支持主从同步，可以从主服务器向任意数量的从服务器上同步数据，从服务器可以是关联其他从服务器的主服务器。这使得 Redis可执行单层树复制，存盘可以有意无意地对数据进行写操作。由于完全实现了发布&#x2F;订阅机制，使得从数据库在任何地方进行数据同步时，可订阅一个频道并接收主服务器完整的消息发布记录。同步对读取操作的可扩展性和数据冗余很有帮助。</p>
<p>Redis不仅仅是简单的key-value存储，更是一个data strutures server（数据结构服务器)，用来支持不同的数值类型。在key-value中，value不仅仅局限于string类型，它可以是更复杂的数据结构。</p>
<ul>
<li><p>二进制安全的string。</p>
</li>
<li><p>List: 一个链表，链表中的元素按照插入顺序排列。</p>
</li>
<li><p>Set: string 集合，集合中的元素是唯一的，没有排序。</p>
</li>
<li><p>Sorted set: 与Set类似，但是每一个string 元素关联一个浮点数值，这个数值被称为Score。元素总是通过它们的Score进行排序，所以不像Set那样可以获取一段范围的元素（例如，获取前10个，或者后10个)。</p>
</li>
<li><p>Hash: 指由关联值字段构成的 Map。字段和值都是string。</p>
</li>
<li><p>Bit array（或者简单称为Bitmap): 像位数值一样通过特别的命令处理字符串，可以设置和清除单独的bit，统计所有bit集合中为1的数量，查找第一个设置或没有设置的bit等。</p>
</li>
<li><p>HyperLogLogs: 这是一个概率统计用的数据结构，可以用来估计一个集合的基数。对于所有的例子，我们都使用redis-cli工具来演示。这是一个简单但非常有用的命令行工具，可以用来给Redis Server 发送命令。</p>
</li>
</ul>
<h2 id="Redis超时"><a href="#Redis超时" class="headerlink" title="Redis超时"></a>Redis超时</h2><p>Redis超时是 Redis的一个特性之一，这个特性可以用在任何一种值类型中。可以给一个key设置一个超时时间，这个超时时间就是有限的生存时间。当生存时间过去，这个key就会自动被销毁。</p>
<ul>
<li>在设置超时时间时，可以使用秒或毫秒。</li>
<li>超时时间一般总是1ms。</li>
<li>超时信息会被复制，并持久化到磁盘中。当Redis服务器停止时(这意味着Redis将保存key 的超时时间)。</li>
</ul>
<h2 id="node-js操作redis"><a href="#node-js操作redis" class="headerlink" title="node.js操作redis"></a>node.js操作redis</h2><p>使用redis模块操作redis</p>
<ul>
<li>redis.createClient()用于创建客户端。</li>
<li>client.set()方法设置单个值。</li>
<li>client.hset()方法用于设置多个字段。</li>
<li>client.hkeys()方法用于返回所有的字段。</li>
<li>client.get()和client.hgetall()方法都用于获取key 所对应的值。</li>
<li>client.quit()用于关闭连接。</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> redis <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"redis"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建客户端</span>
<span class="token keyword">const</span> client <span class="token operator">=</span> redis<span class="token punctuation">.</span><span class="token function">createClient</span><span class="token punctuation">(</span><span class="token number">6379</span><span class="token punctuation">,</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 如果没有密码，则不需要这一步</span>
client<span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span><span class="token number">123456</span><span class="token punctuation">)</span> <span class="token comment">// </span>

<span class="token comment">// 错误处理</span>
client<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Error "</span> <span class="token operator">+</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

client<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connect'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">// 设值</span>
    client<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token string">"this is a value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 把存储对象改成JSON对象 程序将会报错，因为Redis 中存储的是字符串对象</span>
    client<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">user_name</span><span class="token operator">:</span> <span class="token string">'yolo'</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token comment">// 重写toString 即可方法:</span>
    <span class="token comment">// object.prototype.tostring = function ()&#123;</span>
    <span class="token comment">//     return JSON.stringify(this);</span>
    <span class="token comment">// &#125;;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">// 设值</span>
client<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"书名"</span><span class="token punctuation">,</span> <span class="token string">"《Node.js企业级应用开发实战》"</span><span class="token punctuation">,</span> redis<span class="token punctuation">.</span>print<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 同个key不同的字段</span>
client<span class="token punctuation">.</span><span class="token function">hset</span><span class="token punctuation">(</span><span class="token string">"柳伟卫的Spring三剑客"</span><span class="token punctuation">,</span> <span class="token string">"第一剑"</span><span class="token punctuation">,</span> <span class="token string">"《Spring Boot 企业级应用开发实战》"</span><span class="token punctuation">,</span> redis<span class="token punctuation">.</span>print<span class="token punctuation">)</span><span class="token punctuation">;</span>
client<span class="token punctuation">.</span><span class="token function">hset</span><span class="token punctuation">(</span><span class="token string">"柳伟卫的Spring三剑客"</span><span class="token punctuation">,</span> <span class="token string">"第二剑"</span><span class="token punctuation">,</span> <span class="token string">"《Spring Cloud 微服务架构开发实战》"</span><span class="token punctuation">,</span> redis<span class="token punctuation">.</span>print<span class="token punctuation">)</span><span class="token punctuation">;</span>
client<span class="token punctuation">.</span><span class="token function">hset</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"柳伟卫的Spring三剑客"</span><span class="token punctuation">,</span> <span class="token string">"第三剑"</span><span class="token punctuation">,</span> <span class="token string">"《Spring 5 开发大全》"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> redis<span class="token punctuation">.</span>print<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 返回所有的字段</span>
client<span class="token punctuation">.</span><span class="token function">hkeys</span><span class="token punctuation">(</span><span class="token string">"柳伟卫的Spring三剑客"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> replies</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"柳伟卫的Spring三剑客共"</span> <span class="token operator">+</span> replies<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token string">"本:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 遍历所有的字段</span>
    replies<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">reply<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"    "</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> reply<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 获取key所对应的值</span>
client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"书名"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> reply</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// 获取key所对应的值</span>
client<span class="token punctuation">.</span><span class="token function">hgetall</span><span class="token punctuation">(</span><span class="token string">"柳伟卫的Spring三剑客"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> reply</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span> 

    <span class="token comment">// 退出</span>
    client<span class="token punctuation">.</span><span class="token function">quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 清除数据</span>
client<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h1><ul>
<li>使用<code>process.on(&#39;uncaughtException&#39;, function(err)&#123;&#125;)</code>就不会造成接口崩溃了，可惜的是，很多应用在开发时都没有做这样的基本处理，因此都出现了问题，捕获那些咱没有 try-catch 的异常错误。<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 相对于异常来说，内存泄漏也是一个不能忽视的严重问题，而process.on('uncaughtException')的做法很难保证不造成内存的泄漏。</span>
<span class="token comment">// 所以当捕获到异常时，显式地手动杀掉进程并重启Node进程，既可以保证释放内存，又保证了服务后续的正常可用。</span>
process<span class="token punctuation">.</span><span class="token function">on</span> <span class="token punctuation">(</span><span class="token string">'uncaughtException'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'process error is:'</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">restartServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//重启服务</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li>try&#x2F;catch&#x2F;finally，当我们去读取文件遇到异常时，抛出的异常会被try&#x2F;catch捕获，当前的线程就不会英文异常而意外结束了。</li>
<li>async&#x2F;await和promise是无法捕获异步代码的异常的，如下例子，无法捕获setTimeout异步代码里的异常<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span><span class="token punctuation">&#123;</span> 
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span><span class="token punctuation">&#123;</span>
 <span class="token comment">// 一些逻辑代码</span>

<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span><span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'能进来说明可以处理异常信息了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'test.txt'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">&#125;</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token keyword">finally</span><span class="token punctuation">&#123;</span>

    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>nodejs里约定，同步的代码才能捕获异常，异步的代码不能直接使用try、catch</li>
</ol>
<ul>
<li>先看同步代码可以捕获的异常<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">testFunc</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">testAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">await</span> <span class="token function">testFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'能进来，说明异常能处理'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">testAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li>异步代码无法捕获异常<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token function-variable function">testFunc</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">1111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">testAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">await</span> <span class="token function">testFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'能进来，说明异常能处理'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">testAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h2 id="进程崩溃时重启"><a href="#进程崩溃时重启" class="headerlink" title="进程崩溃时重启"></a>进程崩溃时重启</h2><p>进程因异常退出是很常见的事，当遇到崩溃退出的时候，重启就可以了。负责进程崩溃应用自动重启的模块有：</p>
<ul>
<li>forever模块，forever处理crash事件，再开启新的node进程（很少用了，基本都用pm2模块）</li>
<li>pm2模块，支持所有的forever的功能，功能强大，比如0秒切换。</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i pm2 -g
pm2 start app.js<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="大集群：多台机器"><a href="#大集群：多台机器" class="headerlink" title="大集群：多台机器"></a>大集群：多台机器</h2><p>为了应对大流量，需要多台机器进行集群处理，因此可以通过负载均衡策略将流量分发到各个机器上，通过消除单点故障提升应用系统的可用性。常见的集群处理方式是使用Nginx或HAProxy。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/7008504029277847565">Node.js的底层原理</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/7081891057918558221">Node.js 技术架构</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/7045057475845816357">.env 文件原理</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903592554397710">Node.js子进程</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903678227251213">NodeJS中的事件（EventEmitter</a></li>
<li><a target="_blank" rel="noopener" href="https://www.bookstack.cn/read/Nodejs-Roadmap/nodejs-base-what-is-nodejs.md">书栈网node.js教程</a></li>
<li>《Node.js12 实战》</li>
<li>《Node.js 企业级应用开发实战》</li>
<li>《狼叔卷1》</li>
<li>《狼叔卷2》</li>
</ul>

      
    </div>
    <div class="article-footer">
      

    <!-- 

<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/izph" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/izph" target="_blank"><span class="text-dark">iZph</span><small class="ml-1x">Front End Developer</small></a></h3>
        <div>来自HQU、信息与计算科学（数学方向）、前端开发程序员</div>
      </div>
    </figure>
  </div>
</div>
 -->
    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="vcomments"></div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2022/02/21/front_end/koa-base/" title="Koa 基础开发"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2021/12/28/front_end/typescript/" title="TypeScript 知识汇总"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn " data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">    <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
  </div>
  </div>
</nav>
  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>感谢您的支持，我会继续努力的!</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">扫码打赏，你说多少就多少</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码打赏哦</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">扫码打赏，你说多少就多少</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码打赏哦</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
    
        <div class="copyright">
            
                            <!-- <div class="publishby">
        	copyright.theme_by <a href="https://github.com/cofess" target="_blank"> cofess </a>copyright.base_on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div> -->
        </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>






   




   
    
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine"></script>
  <script type="text/javascript">
  var GUEST = ['nick', 'mail', 'link'];
  var meta = 'nick,mail,link';
  meta = meta.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#vcomments',
    verify: false,
    notify: false,
    appId: '',
    appKey: '',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: meta,
    pageSize: '10' || 10,
    visitor: true
  });
  </script>

     







</body>
</html>